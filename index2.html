<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="mobile-web-app-capable" content="yes">
  <title>Animal Blanket Designer</title>
  <style>
  html, body {
    background-image: url(https://morganepeng.com/img/dot_grid2.png);
    background-repeat: repeat;
    background-color: #fdfdfd;
    margin: 0;
    padding: 0;
    height: 100%;
    min-height: -webkit-fill-available;
    overscroll-behavior-y: contain;
    font-family: 'Inter', sans-serif;
    touch-action: manipulation;
  }
  body {
    display: flex;
    height: 100vh;
  }
  header {
    position: absolute;
    top: 0;
    left: 0;
    right: 334px;
    z-index: 100;
    height: 60px;
    padding: 0.5em 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 {
    margin: 0 1rem 0 0.1rem;
    font-size: 1.2rem;
  }
  h2 {
    font-weight: bold;
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }
  h3 {
    font-weight: normal;
    font-size: 1rem;
    margin: 0 0 0.5rem;
  }
  select {
    padding-right: 0.4rem;
  }
  a:link {
    color: #858585;
  }
  a:hover {
    color: #666666;
  }
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  #grid {
    padding-top: 60px;
    flex: 1;
    display: grid;
    padding: 1rem;
    gap: 2px;
    justify-content: center;
    align-content: center;
    overflow-y: auto;
  }
  #gridInner {
    display: grid;
    gap: 2px;
    background: white;
    padding: 0;
    user-select: none;
  }
  .square {
    width: 100%;
    height: auto;
    aspect-ratio: 1 / 1;
    background-color: #eeeeee;
    border: 8px solid transparent;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
  }
  .square svg {
    width:90%;
    height:auto;
    aspect-ratio: 1 / 1;
    pointer-events: none;
  }

  #controls {
    width: 300px;
    padding: 1rem;
    border-left: 1px solid #ddd;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  #closeBtn {
    display:none;
    position: fixed;
    top: 1rem;
    right: 1rem;
  } 
  .control-group {
    margin-bottom: 1.4rem;
  }
  .control-sub-group {
    background-color: #eeeeee;
    padding: 10px;
    border-radius: 0.5rem;
  }
  .control-sub-group:not(:last-child) {
    margin-bottom: 0.5rem;
  }
  .control-sub-group-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .control-footer {
    position: sticky;
    bottom: 0;
    padding: 0 0 0.5rem 0;
    z-index: 1;
  }
  .color-palette {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .color-button {
    width: 32px;
    height: 32px;
    border: 2px solid #ccc;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    box-sizing: border-box;
  }
  .color-button.selected {
    border-color: #000;
  }
  .badge {
    font-size: 0.8rem;
    background: #e0e7ff;
    color: #1e3a8a; padding: 2px 6px;
    border-radius: 6px;
    vertical-align: middle;
  }
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  .icon-button {
    height: 56px;
    border: 2px solid transparent;
    background: #eeeeee;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
  }
  .icon-button.selected {
    border-color: black;
  }
  .icon-button img {
    width: 52px;
    height: 52px;
  }
  input[type="color"] {
    width: 32px;
    height: 32px;
    box-sizing: border-box;
  }
  input[type="color"].selected,
  input[type="color"]:focus {
    outline: none;
  }

  select, button {
    font-family: inherit;
    font-size: 1rem;
    font-weight: 500;
    padding: 0.5em;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  select {
    border: 1px solid #ccc;
    background: white;
    color: #333;
    cursor: pointer;
    padding-right: 2em;
    background-position: right 0.75em center;
    background-repeat: no-repeat;
    background-size: 0.65em auto;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpolyline points='4,8 10,14 16,8' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75em center;
    background-size: 0.65em auto;
  }
  select:hover {
    background: #f9f9f9;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpolyline points='4,8 10,14 16,8' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75em center;
    background-size: 0.65em auto;
  }
  button {
    border: 1px solid #ccc;
    background: #ffffff;
    color: #333;
    cursor: pointer;
    min-width: 42px;
  }
  button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }
  button:hover {
    background: #f9f9f9;
  }
  button svg {
    pointer-events: none;
  }
  button.palette {
    display: none;
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }
  .button-group {
    display: flex; align-items: center; gap: 0.5rem; align-self: center;
  }
  .button-group-space-between {
    display: flex; justify-content: space-between; gap: 0.5rem;
  }
  .dropdown {
    position: relative;
  }
  .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.25rem;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    z-index: 200;
    overflow: hidden;
  }
  .dropdown-menu.open {
    display: block;
  }
  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.6rem 1rem;
    border: none;
    background: none;
    font-size: 0.95rem;
    font-weight: 400;
    color: #333;
    cursor: pointer;
    text-decoration: none;
    box-sizing: border-box;
    border-radius: 0;
    box-shadow: none;
  }
  .dropdown-item:hover {
    background: #f5f5f5;
  }
  .dropdown-item svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  .dropdown-menu a.dropdown-item:link,
  .dropdown-menu a.dropdown-item:visited {
    color: #333;
  }
  .dropdown-menu a.dropdown-item:hover,
  .dropdown-menu a.dropdown-item:active {
    color: #333;
  }
  .dropdown-divider {
    height: 1px;
    background-color: #e5e5e5;
  }
  /* Modal styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1100;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.open {
    display: flex;
  }
  .modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    max-width: 480px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
  }
  .modal-header h2 {
    margin: 0;
    font-size: 1.1rem;
  }
  .modal-close {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: auto;
    box-shadow: none;
  }
  .modal-close:hover {
    color: #333;
    background: #f0f0f0;
    border-radius: 4px;
  }
  .modal-body {
    padding: 0 1.25rem 1.25rem 1.25rem;
    overflow-y: auto;
  }
  .yarn-section {
    margin-bottom: 2rem;
  }
  .yarn-section:last-child {
    margin-bottom: 0;
  }
  .yarn-section-title {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 0.5rem;
  }
  .yarn-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0;
    flex-wrap: wrap;
  }
  .yarn-color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ccc;
    flex-shrink: 0;
  }
  .yarn-color-name {
    flex: 1;
    font-size: 0.95rem;
    min-width: 80px;
  }
  .yarn-amount {
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
  }
  .yarn-count {
    color: #888;
    font-size: 0.85rem;
    white-space: nowrap;
  }
  .modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .yarn-total {
    font-weight: 600;
  }
  .yarn-empty {
    text-align: center;
    color: #888;
    padding: 2rem 1rem;
  }
  .yarn-disclaimer {
    background: #f8f8f8;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1.25rem;
    line-height: 1.4;
  }
  .mode-toggle {
    display: flex;
    width: 100%;
    justify-content: space-between;
    border-radius: 0.5rem;
    background-color: #eeeeee;
    padding: 4px;
    box-sizing: border-box;
  }
  .mode-btn {
    flex: 1;
    padding: 0.5em 1em;
    font-size: 1rem;
    font-weight: 500;
    border: 1px solid transparent;
    background: none;
    color: #374151;
    border-radius: 0.375rem;
    cursor: pointer;
    box-shadow: 0 0px 0px rgba(0, 0, 0, 0);
  }
  .mode-btn:hover {
    background-color: #f0f0f0;
  }
  .mode-btn.selected {
    background-color: #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .flex-grow {
  flex: 1;
  }
  .muted {
    font-size: 0.9rem;
    color: #858585;
  }
  
  #hint {
    display: none;
  }

  @media (max-height: 780px) {
    .icon-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 1260px) {
    .hide-ms {
      display: none;
    }
    #controls {
      display: block; 
      width: 300px;
      padding: 1rem;
      border-left: 1px solid #ddd;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .square svg {
      width:85%;
      height:85%;
    }
  }

  @media (max-width: 800px) {
    .hide-xs {
      display: none;
    }
    #hint {
      display: block;
    }
    .square {
      border: 6px solid transparent;
    }
    .square svg {
      width:75%;
      height:75%;
    }
    header {
      right: 0;
      z-index: 1002;
    }
    button.palette {
      display: block;
    }
    #controls {
      padding: 2.5rem 1rem 2.5rem 1rem;
      display: none; 
      position: fixed;
      top: 0px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1001;
      box-sizing: border-box; 
      border-top: 1px solid #ddd;
      border-radius: 0.5rem 0.5rem 0;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .icon-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
</head>

<body>
<header id="header">
  <div class="button-group">
    <div class="hide-ms">
      <h1>Animal Blanket Designer <span class="badge">v1</span></h1>
      <span class="muted">Edit then add on the grid. <a href="https://morganeyarn.com" target="_blank">Get patterns â†—</a></span>
    </div>
    <select id="layout">
      <option value="4x4" data-short="4 x 4">4 x 4 squares</option>
      <option value="4x5" data-short="4 x 6">4 x 6 squares</option>
      <option value="5x5" data-short="5 x 5">5 x 5 squares</option>
      <option value="5x6" data-short="5 x 6" selected>5 x 6 squares</option>
      <option value="6x5" data-short="6 x 5">6 x 5 squares</option>
      <option value="6x6" data-short="6 x 6">6 x 6 squares</option>
      <option value="6x8" data-short="6 x 8">6 x 8 squares</option>
    </select>
  </div>
  <div class="button-group">
    <button id="undoBtn" aria-label="Undo" title="Undo (Ctrl+Z)" disabled><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M280-200v-80h284q63 0 109.5-40T720-420q0-60-46.5-100T564-560H312l104 104-56 56-200-200 200-200 56 56-104 104h252q97 0 166.5 63T800-420q0 94-69.5 157T564-200H280Z"/></svg></button>
    <button id="redoBtn" aria-label="Redo" title="Redo (Ctrl+Y)" disabled><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M396-200q-97 0-166.5-63T160-420q0-94 69.5-157T396-640h252L544-744l56-56 200 200-200 200-56-56 104-104H396q-63 0-109.5 40T240-420q0 60 46.5 100T396-280h284v80H396Z"/></svg></button>
    <button id="exportBtn" aria-label="Export as image" title="Export as image"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg></button>
    <div class="dropdown">
      <button id="menuBtn" aria-label="More options" title="More options"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-160q-33 0-56.5-23.5T400-240q0-33 23.5-56.5T480-320q33 0 56.5 23.5T560-240q0 33-23.5 56.5T480-160Zm0-240q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Zm0-240q-33 0-56.5-23.5T400-720q0-33 23.5-56.5T480-800q33 0 56.5 23.5T560-720q0 33-23.5 56.5T480-640Z"/></svg></button>
      <div id="dropdownMenu" class="dropdown-menu">
        <button id="yarnQuantitiesBtn" class="dropdown-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M208-120q-37 0-62.5-25.5T120-208v-548q0-29 27-40.5t47 8.5l90 90-54 54 28 28 54-54 104 104-54 54 28 28 54-54 104 104-54 54 28 28 54-54 104 104-54 54 28 28 54-54 80 80q20 20 8.5 47T756-120H208Zm32-120h332L240-572v332Z"/></svg>
          Get yarn quantities
        </button>
        <button id="shareLinkBtn" class="dropdown-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85q0-50 35-85t85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5q0 8-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85q0 50-35 85t-85 35Z"/></svg>
          Share your design
        </button>
        <div class="dropdown-divider"></div>
        <button id="saveJsonBtn" class="dropdown-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M840-680v480q0 33-23.5 56.5T760-120H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h480l160 160Zm-80 34L646-760H200v560h560v-446ZM480-240q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM240-560h360v-160H240v160Zm-40-86v446-560 114Z"/></svg>
          Save configuration
        </button>
        <button id="loadJsonBtn" class="dropdown-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M440-200h80v-167l64 64 56-57-160-160-160 160 57 56 63-63v167ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>
          Load configuration
        </button>
        <div class="dropdown-divider"></div>
        <a href="https://morganeyarn.com/contact" target="_blank" class="dropdown-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="m480-80-10-120h-10q-142 0-241-99t-99-241q0-142 99-241t241-99q71 0 132.5 26.5t108 73q46.5 46.5 73 108T800-540q0 75-24.5 144t-67 128q-42.5 59-101 107T480-80Zm80-146q71-60 115.5-140.5T720-540q0-109-75.5-184.5T460-800q-109 0-184.5 75.5T200-540q0 109 75.5 184.5T460-280h100v54Zm-101-95q17 0 29-12t12-29q0-17-12-29t-29-12q-17 0-29 12t-12 29q0 17 12 29t29 12Zm-29-127h60q0-30 6-42t38-44q18-18 30-39t12-45q0-51-34.5-76.5T460-720q-44 0-74 24.5T344-636l56 22q5-17 19-33.5t41-16.5q27 0 40.5 15t13.5 33q0 17-10 30.5T480-558q-35 30-42.5 47.5T430-448Zm30-65Z"/></svg>
          Contact
        </a>
      </div>
    </div>
    <input type="file" id="loadJsonInput" accept=".json" style="display: none;">
    <button aria-label="Configure" class="palette" id="toggleControlsBtn"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-220 40q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120-160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm200 0q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120 160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T488-800q-136 0-232 93t-96 227q0 133 93.5 226.5T480-160Z"/></svg></button>
  </div>
</header>

<!-- Yarn Quantities Modal -->
<div id="yarnModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Yarn quantities</h2>
      <button id="yarnModalClose" class="modal-close" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
      </button>
    </div>
    <div id="yarnModalBody" class="modal-body">
      <!-- Content populated by JS -->
    </div>
    <div class="modal-footer">
      <span class="yarn-total" id="yarnTotal">Total: 0m</span>
    </div>
  </div>
</div>

<!-- Share Link Modal -->
<div id="shareModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
    <h2>Share your design</h2>
      <button id="shareModalClose" class="modal-close" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="yarn-disclaimer">
        ðŸ§¶ Use this link to share your design with others. Anyone opening it will see the same layout, colors, and animals youâ€™ve chosen.
      </div>
      <div style="display: flex; margin-bottom: 0.5rem;">
        <input type="text" id="shareUrlInput" readonly style="flex: 1; padding: 0.75rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem;">
      </div>
      <div class="button-group-space-between ">
        <button id="copyShareUrlBtn" class="flex-grow">Copy URL <span id="shareCopyStatus" class="muted" style="color: #495f4a; display: none;">âœ“ Copied to clipboard!</span></button>
      </div>
      </div>
  </div>
</div>

<div id="hint" style="position: fixed; top: 64px; right: 28px;"><svg xmlns="http://www.w3.org/2000/svg" height="90px" viewBox="0 0 100 70">
  <text style="fill: rgb(51, 51, 51); font-family: Caveat; font-size: 20px; white-space: pre; text-anchor: middle;" transform="matrix(1, 0, 0, 1, 40.798481, -65.23407)"><tspan x="0" y="107.918">try the <tspan x="0" dy="1em">â€‹</tspan>config </tspan><tspan>panel</tspan></text>
  <defs><style bx:fonts="Caveat">@import url(https://fonts.googleapis.com/css2?family=Caveat%3Aital%2Cwght%400%2C400..700&amp;display=swap);</style></defs><path style="fill: none; stroke: black; stroke-width: 2px; stroke-linecap: round;" d="M 74.294 39.624 C 78.804 41.127 83.8 34.712 86.108 31.827 C 93.746 22.279 96.032 13.246 96.032 1.347"/><path style="fill: none; stroke: black; stroke-width: 2px; stroke-linecap: round;" d="M 92.961 9.381 C 92.961 7.574 94.877 2.739 96.032 1.584 C 96.405 1.211 97.556 2.569 97.686 2.765 C 98.561 4.077 99.104 5.275 99.104 7.254"/></svg>
</div>
<main>
  <div id="grid"><div id="gridInner"></div></div>
</main>
<aside id="controls">
  <button id="closeBtn"><svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button>
  <div class="control-group">
  <h2>Edit mode</h2>
  <div class="mode-toggle">
    <button type="button" class="mode-btn selected" data-mode="all">All</button>
    <button type="button" class="mode-btn" data-mode="color">Color</button>
    <button type="button" class="mode-btn" data-mode="pattern">Animal</button>
  </div>
  </div>
  <div class="control-group">
    <h2>Square colors</h2>
    <div class="control-sub-group">
      <h3>Background</h3>
      <div class="control-sub-group-item">
        <div class="color-palette" id="bgPalette"></div>
        or <input type="color" id="bgColor" value="#c7aae4"/>
      </div>
    </div>
    <div class="control-sub-group">
      <h3>Border</h3>
      <div class="control-sub-group-item">
        <div class="color-palette" id="borderPalette"></div>
        or <input type="color" id="borderColor" value="#856d9c"/>
      </div>
    </div>
  </div>
  <div class="control-group">
    <h2>Square animals</h2>
    <div class="icon-grid" id="iconGrid"></div>
  </div>
  <div class="control-footer button-group-space-between hide-xs">
    <button id="applyAllBtn" class="flex-grow">Set all</button>
    <button id="randomizeBtn" class="flex-grow">Shuffle</button>
    <button id="clearBtn" aria-label="Clear" class="flex-grow" class="hide-ms">Clear</button>
  </div>
</aside>

<script>
(() => {
  // ============================================================
  // CONFIGURATION
  // ============================================================
  const Config = {
    UNDO_STACK_LIMIT: 50,
    RESIZE_DEBOUNCE_MS: 150,
    DEFAULT_SQUARE_BG: '#eeeeee',
    DEFAULT_SQUARE_BORDER: 'transparent',
    PRESET_BG_COLORS: ['#f0ead5', '#849587', '#c9a68d', '#ebad93', '#93c3eb'],
    PRESET_BORDER_COLORS: ['#495f4a', '#e1c8a7', '#cd896d', '#506584'],
    
    ICON_SVGS: [
      { id: 'Highland_Cow', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#ab662e" fill-rule="evenodd" d="m151 255-10 3c-36 8-73 35-81 59-12 38-6 75 15 100l14 17c21 25 36 37 60 47 20 7 25 9 38 11a705 705 0 0 1 41 5c12 0 12 0 8 14a379 379 0 0 0-15 64c-1 6-14 38-14 68a449 449 0 0 0 50 244c31 50 72 77 106 98 45 30 58 39 123 49a534 534 0 0 0 222-10c10-2 77-19 122-60 2-1 56-36 95-102 9-14 19-35 29-56 10-23 12-29 23-65 11-33 10-40 12-64 0-10 4-48-9-107-12-58-13-49-14-53-2-8-3-7 9-10a213 213 0 0 0 100-55c19-18 38-62 38-89-1-17-6-35-13-44-2-1-5-6-7-11-29-55-104-61-175-12-18 13-28 22-37 33-8 12-61-28-161-42-25-4-68-18-129-14-28 1-36 3-55 6-26 4-95 24-94 24 5 0-52 12-107 28-10 2-46 18-44 15 6-17-38-66-71-82-16-7-54-12-69-9"/><path fill="#f0e4c9" fill-rule="evenodd" d="M777 165c-20 9-63 118-54 137 3 6 20 13 36 15l19 3c18 4 38-3 41-14a448 448 0 0 0-12-96c-5-29-8-38-14-43-4-3-12-4-16-2m-389 8c-12 7-13 15-13 82 0 66 0 66 14 66l5 2c5 6 18 7 23 2l8-4c27-5 44-22 37-36l-1-7c0-6-4-19-10-31l-10-23c-18-43-37-61-53-51m171 507c-127 11-204 86-167 163 56 116 319 127 392 16 60-91-68-193-225-179m97 107c-13 6-14 47-2 54 15 9 24-2 24-28 0-24-8-34-22-26m-153 1c-15 7-16 57-1 64 14 8 20 0 22-31 1-30-5-40-21-33"/><path fill="#9b5925" fill-rule="evenodd" d="m649 266-29 1c-22 0-28 5-29 6-6 2-8 24-4 51l4 31 10 78c5 29 5 40 5 81-2 81 8 93 75 93l36 1c16 2 27-6 32-24 4-19 5-102 1-144-2-12-2-29-2-51-1-45-4-37-10-72-2-10 0-11-12-30-10-15-38-25-77-21m-157 2c-17 4-30 9-30 10s-29 18-38 46c-1 1-2 2-2 8-1 16 0 26 4 55a541 541 0 0 1 7 94l1 45c2 46 4 58 12 67 20 21 119 3 131-23a1206 1206 0 0 0-3-198c-1-50 0-64-20-84l-15-12c0-7-32-12-47-8m287 37c-24-7-31 22-25 91l2 31 3 34a673 673 0 0 1 9 106c1 38 5 43 32 47 52 8 89-3 96-27 5-14 4-51-1-173-2-31-7-53-17-67l-24-29m-524 4c-36 7-42 13-41 43l-2 36a1166 1166 0 0 0 4 166c2 18 3 22 12 29 7 6 7 6 18 7l22 1c34 2 63-5 63-16l7-8c10-10 11-21 8-70l-1-79c2-73 2-72 0-80-3-12-8-20-14-21l-11-4-13-5c-7-3-34-3-52 1"/><path fill="#191920" fill-rule="evenodd" d="M394 616c-33 11-48 57-25 78 34 31 79 9 79-39 0-28-27-48-54-39m351 5c-28 13-33 50-12 75 25 30 77 7 77-33 0-32-37-56-65-42"/></svg>' },
      { id: 'Giraffe', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#dba24c" fill-rule="evenodd" d="M496 161c-5 1-26 0-34 2-32 6-23 14-31 11-2 0-3 0-4 12l-4 24c-3 18-3 53 0 81 3 39 5 34-15 44-44 23-86 56-118 94-12 14-10 13-15 3a219 219 0 0 0-16-30c-13-23-28-40-48-55l-16-13c-13-12-18-15-28-21l-19-10c-20-12-51-17-64-10-41 20-19 131 37 185 23 22 80 53 99 53 7 0 7 1 2 14-11 30-21 64-22 101-2 58 7 77 20 137 2 11 17 55 41 90a385 385 0 0 0 685-122c19-69 18-145-5-211-4-13-4-13 10-12 68 2 150-59 159-117l3-17c4-15 0-50-7-65-16-34-76-28-124 13l-18 15c-32 26-46 43-66 80-4 7-5 8-6 6-14-19-19-22-32-37-42-46-91-77-90-95l4-22c5-30 6-53 3-80-2-24-2-24-6-23-7 2-14-9-24-14-13-6-47-1-53-5-2-1-21 3-21 3l-1 8-3 15-4 34a1681 1681 0 0 1-5 65c0 6 0 6-3 5-38-7-102-7-129-1-3 1-3 1-3-6l-1-19-2-43c-3-42-4-62-6-63"/><path fill="#9b5925" fill-rule="evenodd" d="M718 61c-16 5-37 31-44 54-16 52-9 63 36 61 21 0 24 0 38 7 21 10 43 0 43-20 0-12-7-50-12-63-11-30-37-47-61-39m-255 1c-24 6-47 34-48 57-3 57 6 64 71 50l31-4c29-5 28-58-2-91-11-12-34-17-52-12m301 268c-31 12-41 88-16 115 35 38 105 36 117-2 0-2 2-4 4-6 22-25-22-81-79-101l-13-5c-6-3-7-3-13-1M226 643c-13 2-28 10-32 17-7 11 5 83 18 115 9 21 56 4 69-25 22-47-13-113-55-107m657 92c-53 13-73 91-33 128 12 11 36 15 45 7 16-16 37-58 41-82 0-4 2-10 4-14 11-24-23-48-57-39m-406 11c-14 3-17 10-19 46-2 39 1 48 16 48 19 0 30-21 30-59 1-32-5-41-27-35m183 0c-20 9-19 86 0 97 20 10 29-8 28-51-1-42-9-54-28-46"/><path fill="#e7c8a4" fill-rule="evenodd" d="M546 644c-150 12-243 100-200 188 68 139 391 144 461 7 53-102-89-209-261-195m-65 100-7 2c-19 5-25 84-8 93 22 11 40-18 40-65 0-23-11-36-25-30m180 1c-20 6-22 84-3 97 20 14 32-6 31-51-1-40-9-52-28-46"/><path fill="#1e1d23" fill-rule="evenodd" d="M399 571c-34 12-33 73 1 83 39 11 71-46 41-73-11-10-30-14-42-10m331 6c-33 7-39 67-7 74s56-15 50-45c-5-21-23-34-43-29"/></svg>' },
      { id: 'Owl', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#62625b" fill-rule="evenodd" d="M556 219c-66 7-114 22-173 54-4 3-4 3-14-7-18-19-38-29-66-33l-17-2c-9-3-28-2-45 0l-9 1c-16 2-34 9-38 15-3 3-3 3-4 16l-2 13a559 559 0 0 0 3 91c4 27 19 67 31 82a454 454 0 0 0-23 72c-3 15-4 15-11 25-25 36-38 76-45 139-6 55-2 92 16 151 34 112 53 148 88 166 28 14 50-9 50-52 0-11 0-11 15-11 20 1 27-3 35-19 4-8 37 27 37 29 0 26 311 18 337 18 12 0 93-32 94-26 4 35 34 39 66 8l18-16c16-13 33-44 61-103a458 458 0 0 0 41-230c-7-38-20-64-40-85-7-7-7-7-10-20a415 415 0 0 0-11-36l5-6c26-27 53-89 53-125 1-38-15-74-36-84-16-7-51-11-69-7-35 8-61 20-89 41-5 4-5 4-18-4a398 398 0 0 0-230-55"/><path fill="#e7c8a4" fill-rule="evenodd" d="M737 352c-39 2-66 18-91 55-14 21-20 82-10 101 5 9 5 10 5 20 0 12 3 18 14 29l16 17c20 22 43 35 81 44 32 9 58 0 88-31l19-18c14-13 20-24 21-38l4-16c5-17 4-36-4-73-12-49-40-77-87-83l-18-4c-6-2-15-5-19-4l-19 1m-372 9-17 5c-5 0-21 4-30 8-55 26-78 91-55 155l7 21c8 34 29 54 69 69a139 139 0 0 0 89-15c10 0 49-31 62-50 37-52 18-149-37-184-22-14-61-18-88-9m235 200c-23 30-48-7-67 0-13 5-44 19-53 28-8 8-37 25-43 25-21 0-52 39-42 54 11 17 12 43 2 58-5 7-5 6 2 13 24 27 18 70-11 85l-9 4c-5 3-5 3-4 8 4 13 0 26-11 38-9 10-5 43 6 47 3 0 3 3 1 3l1 2a1153 1153 0 0 1 185 49c2 3 2 3 22 2 35-1 33-1 36-9 8-24 130-32 135-31 6 2 13-24 11-31-2-4-2-8-2-13 1-6 1-6-4-9-7-4-12-9-16-17l-6-11c-7-9-6-19 3-38 4-10 4-10 2-11-28-7-36-52-13-77 6-6 6-6 2-11-8-11-10-38-3-58 3-10 3-10 0-15l-14-21-8-9-17-16-15-13c-5-5-24-13-37-16"/><path fill="#fffaea" fill-rule="evenodd" d="M743 390c-21 5-41 19-51 36-13 23-12 26-12 31 1 46 1 67 4 73 26 51 164-28 164-66 0-18-12-38-28-59-27-33-73-16-77-15m-362 7c-23 3-56 39-64 69-11 40 5 83 35 97 53 25 99 9 117-38 3-9 8-62 7-66-9-48-40-68-95-62"/><path fill="#191920" fill-rule="evenodd" d="M443 453c-23 6-31 15-31 35 0 40 52 51 70 15 16-33-4-59-39-50m245 0c-27 11-34 48-13 64 29 21 64 4 64-31 0-25-28-43-51-33"/><path fill="#e98f13" fill-rule="evenodd" d="M548 493c-44 5-53 28-25 64 40 49 60 54 87 20l8-9h1l5-8c21-23 23-40 7-60-6-8-47-12-83-7m170 417-13 2c-12 2-21 4-31 8l-15 4c-27 3-56 46-43 65 6 9 19 13 28 10l13-3 16-2c10-3 12-2 22 11 23 29 52 28 51-2 0-7 0-9 3-15l3-15c1-7 1-8 3-9 16-5 26-30 15-41l-6-9-2-2-5-1c-4-2-31-2-39-1m-316 13a176 176 0 0 0-26 5c-31 6-25 40 11 58 9 4 9 4 9 16 1 59 42 72 66 20 7-14 7-14 15-14l12-1c4-1 7-1 14 1 9 2 35 2 40 0 12-4 21-24 14-33-9-14-16-20-33-32-22-15-24-16-37-17l-16-2c-5-1-56-2-69-1"/></svg>' },
      { id: 'Lion', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#c97409" fill-rule="evenodd" d="M643 123c-44 6-78 24-114 61-14 15-14 15-18 9-32-37-69-46-129-28-27 8-88 56-78 62 0 0-116 91-112 92 16 7 749 13 798 20 20 2-71-123-80-132-24-24-38-27-103-23-22 2-41 8-54 18-4 3-4 4-5-6-7-47-54-80-105-73m348 215c-4 11-813-3-825 15-21 30-20 78 1 108 3 3 2 4-3 6-5 1-17 7-26 13l-15 8c-59 34-73 94-36 150 11 16 21 24 53 44 8 5 15 9 14 10l-9 6c-51 36-56 81-18 164 21 48 72 71 119 53 1-1 1 1 1 15 0 22 2 28 17 65 41 104 136 116 216 27l10-11a202 202 0 0 1 11 27c5 12 26 36 40 46 31 20 106 15 140-9 32-23 58-52 63-71 1-6 2-6 4-2 26 38 86 36 150-6 24-15 47-57 51-93 2-10 1-62 0-66-1-2-1-2 4-2 19 3 59-16 80-38 44-46 41-122-6-186-4-6-6-4 12-19 12-10 20-20 27-33l10-16c19-28 21-75 6-119-7-22-42-65-64-78"/><path fill="#e0a862" fill-rule="evenodd" d="M879 216c-50 6-88 39-92 79l-1 7-11-6a364 364 0 0 0-383 15c-8 5-8 5-8 1 0-35-54-85-94-86-66-2-121 53-111 111l2 17c4 39 40 78 72 76h28l-7 15a344 344 0 0 0 323 497c267-6 434-288 305-518-4-9-5-8 14-17 64-30 83-58 77-113-6-49-35-77-82-78a287 287 0 0 1-32 0M581 576c-81 14-127 127-88 219 53 124 193 82 205-61 8-88-52-169-117-158"/><path fill="#f0e9d4" fill-rule="evenodd" d="M581 576c-81 14-127 127-88 219 53 124 193 82 205-61 8-88-52-169-117-158m-7 27c-40 5-54 24-39 50 18 32 25 42 31 43 3 1-1 7-25 36-17 20-19 33-9 39 11 6 20-1 47-38 13-18 14-19 20-11 14 19 41 45 47 45 20 0 14-18-22-61l-5-7c-1-1-1-2 6-7 28-20 40-44 32-61-13-25-38-34-83-28"/><path fill="#1e1d24" fill-rule="evenodd" d="M423 549c-44 18-32 85 14 81 25-2 39-27 31-57-5-17-30-30-45-24m306 5c-22 10-29 46-12 60 24 20 60 5 63-27 3-22-29-43-51-33"/></svg>' },
      { id: 'Elephant', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#ac95ba" fill-rule="evenodd" d="m562 217-13 1c-33 1-73 10-110 23l-27 8c-31 6-60 20-88 43a369 369 0 0 0-78 97c-1 1-3-1-6-4a83 83 0 0 0-68-27c-30 5-74 22-93 38-29 22-57 87-64 151-6 54 16 112 53 139 31 23 103 39 130 29l6-2 4 9a384 384 0 0 0 237 228c4 1 17 2 20 7 10 18 14 51 20 61 9 15 23 33 36 33 31-2 87 10 127-15 46-27 48-86 52-87a401 401 0 0 0 259-266l14 5c46 16 107-7 146-57 34-43 46-102 34-164-9-44-65-102-105-110-35-7-104 25-121 57-2 3-3 1-14-19a229 229 0 0 0-60-73l-18-14c-6-3-11-6-12-8-3-4-14-12-33-24l-15-11a215 215 0 0 0-78-31 383 383 0 0 0-135-17Z"/><path fill="#7b728b" fill-rule="evenodd" d="M513 665a806 806 0 0 0-40 10c-16 3-41 33-45 57-1 7-1-7 1 29l1 20c2 41 6 86 10 103a642 642 0 0 0 23 85c0 8 9 16 17 16 6 0 12-7 11-13a546 546 0 0 0-18-54l-6-24a343 343 0 0 1-10-81c-2-18-4-7-6-53-1-22 9-57 24-60l22-8c21-6 24-6 39-6l63 2c60 1 86 5 93 17 7 11 14 36 13 62a670 670 0 0 1-54 264c-7 10-3 11 11 1l17-11c4-2 5-4 11-20 4-10 10-29 11-37l4-14c8-27 13-49 15-66l4-30a407 407 0 0 0 1-101c-3-11-3-4 0-9 5-7-7-48-17-56-3-3-21-12-26-14l-31-7-37-1-101-1"/><path fill="#fffaea" fill-rule="evenodd" d="M370 673c-19 5-23 28-13 83l5 29c7 46 51 33 54-16l6-50c8-35-15-56-52-46m364 0c-10 4-13 16-8 38l2 16 1 20 2 22c0 24 17 40 34 31 11-6 23-37 24-66l2-20c10-28-25-54-57-41"/><path fill="#f19772" fill-rule="evenodd" d="M141 431c-50 12-70 42-71 108-2 45 7 61 44 81 34 19 83 7 80-20-2-19 0-50 3-68 4-20 10-42 14-55 7-24 3-34-13-36l-10-2c-17-8-34-11-47-8m862 12c-14 3-33 14-43 24-12 13-13 28-5 58 4 17 5 23 6 58 2 47 23 49 83 10 30-19 55-70 50-98-6-34-53-60-91-52M527 741c-8 5-6 17 3 23l26 1a392 392 0 0 1 75 7l19 4c13 4 21-1 19-12-1-11-9-15-34-17-18-1-34-3-51-6-15-3-52-3-57 0m14 72c-7 2-10 13-5 18 5 6 6 6 38 6s49 2 56 6c10 5 21-10 15-20-4-6-7-7-19-9l-13-1h-72m21 67c-14 2-19 6-19 15 0 10 7 13 23 11 22-3 44-2 49 2 14 12 29-8 16-21-7-8-39-10-69-7m33 82c-33 5-51 13-49 23 3 12 9 13 42 4 8-2 9-2 12 0 10 6 20-1 20-13-1-12-9-16-25-14"/><path fill="#1c1c25" fill-rule="evenodd" d="M750 547c-10 2-29 18-34 30-18 41 46 73 74 37 24-32 15-62-22-66a5355 5355 0 0 1-18-1m-359 4c-38 10-47 78-12 86 32 8 67-26 61-58-3-15-34-32-49-28"/></svg>' },
      { id: 'Duck', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#f9d76d" fill-rule="evenodd" d="M585 106c-13 6-17 27-12 69a23660 23660 0 0 1 9 66l-36 1a283 283 0 0 0-106 16 281 281 0 0 0-92 50c-35 25-54 41-64 52a243 243 0 0 0-68 152l-5 31a508 508 0 0 0 4 217c33 89 89 153 178 201 37 20 44 22 81 28a449 449 0 0 0 335-70c32-27 38-34 63-66 30-39 30-39 42-64l22-44c12-23 22-51 25-68a585 585 0 0 0 0-163c-2-25-5-35-12-55a433 433 0 0 0-49-89l-6-10c-4-7-40-40-68-60-27-21-34-24-81-38l-48-12 17-14c29-23 37-47 17-59-18-12-38-6-59 18a172 172 0 0 1-41 33c-2-2-1-16 3-26 8-24 3-56-13-81-3-4-8-9-10-9l-6-3c-7-5-14-6-20-3"/><path fill="#e98f13" fill-rule="evenodd" d="M573 554c-26 4-39 13-52 33-11 17-48 39-72 42-67 10-107 77-69 116 15 15 37 16 104 5a781 781 0 0 1 253 15c27 7 43 2 61-17 30-32 31-55 3-83l-18-19c-10-13-21-20-42-25-32-7-61-21-72-35-22-25-61-38-96-32"/><path fill="#1f1f24" fill-rule="evenodd" d="M749 510c-22 5-40 36-33 55 16 40 78 28 78-15 0-23-25-45-45-40m-348 3c-37 12-38 71-3 82 44 12 74-33 47-69-8-10-32-17-44-13"/></svg>' },
      { id: 'Tiger', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#db8010" fill-rule="evenodd" d="M556 204c-65 4-116 17-170 44-24 11-22 10-19 16 5 13-20 36-60 13-37-22-92-26-121-19-28 8-28 58 1 105 19 31 23 46 15 76-3 11 1 24-10 24-7 0-8 1-17 30a392 392 0 0 0-9 163c8 35 7-17 14 46 1 10 24 68 49 103 159 221 510 214 671-13 24-35 52-109 52-109 3 0 17-66 15-69v-24c-1-45 1-59-7-93-3-14-3-14-2-17 1-1-2-20-5-20-27 0-19-2 0-39 4-9 5-25 7-32l7-35c5-20-12-73-23-79-16-10-60-10-93 5-29 13-61-2-58-14v-2l-12-6a416 416 0 0 0-201-53c17 13-10-2-10-2"/><path fill="#fbfbeb" fill-rule="evenodd" d="m731 629-26 1h-45c-43-1-125 10-155 8-9-1-21-9-64-1-67 14-109 69-112 147-2 26 9 54 24 65l13 11c55 51 176 47 213-7 4-4 4-4 10 2 6 7 28 24 35 28a220 220 0 0 0 138-5c43-15 61-32 74-70 8-24 8-80 0-96l-6-13c-4-14-24-41-36-49-24-17-48-25-63-21"/><path fill="#a95d00" fill-rule="evenodd" d="M204 200c-42 5-71 28-80 66a275 275 0 0 0 30 157c13 32 32 47 49 37 22-13 21-57-3-97-29-47-29-84 0-92 28-7 62 0 99 22 39 24 49 26 62 12 8-9 11-28 6-40l-2-6c3-4-30-29-53-41-30-15-71-22-108-18m360 6c-22 11-23 14-23 105-1 69-1 63 5 83 4 13 10 18 21 18 27 0 32-23 32-126 0-53-2-68-13-76l-7-6c-3-2-7-2-15 2m315 17c-38 6-82 29-86 45-3 10-1 15 10 26 15 16 28 17 57 4 33-14 64-17 80-7 10 6 17 42 11 62l-5 19c-1 7-4 15-8 23-19 38-9 84 17 84l4 1c0 3 14-5 18-11 4-4 11-21 15-35l12-35a158 158 0 0 0 4-102c-2-16-8-29-16-37l-5-5c-6-24-61-40-108-32m-211 4c-17 7-17 84 0 93 26 12 45-38 31-80-4-11-20-18-31-13m-218 1-4 1c-4 1-16 11-17 15-7 21-5 63 3 80s29 16 36-2c3-7 7-40 7-54 0-26-11-44-25-40M212 546l-10 2-14 3-10 4c-13 3-20 9-18 17s16 27 24 31c5 3 74 1 80-2 23-13 19-40-6-47l-13-5c-9-3-31-6-33-3m669 24c-27 7-39 17-39 33 0 12 11 23 22 22l11 1c46 15 92 5 96-22 3-12-15-27-36-33-7-2-48-2-54-1m-307 43c-34 3-73 13-77 23-4 9-3 15 7 29l14 20c46 69 125 61 149-15 10-32 2-50-21-50l-13-4c-8-3-40-5-59-3m-390 42-8 4-8 5c-14 7-7 34 11 38 25 6 57 7 64 3 24-12 17-40-11-45-4 0-11-2-15-4-10-3-26-3-33-1m712 4c-18 3-35 29-27 43 10 15 56 21 70 8l6-4c8 0 14-19 8-22l-3-4c-2-4-10-12-14-14-7-4-29-9-34-8l-6 1"/><path fill="#191920" fill-rule="evenodd" d="M731 540c-25 12-31 42-13 60 12 13 40 15 52 3 28-28-4-80-39-63m-336 1c-34 8-41 64-9 75 40 13 79-36 49-63a46 46 0 0 0-40-12"/></svg>' },
      { id: 'Dog', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#dbb383" fill-rule="evenodd" d="M544 245c-58 4-134 28-186 57-14 9-157 378-160 387-8 22 11 69 39 117 164 277 592 242 702-57 6-16 14-45 9-53-13-21-109-392-158-393-5 0-27-18-42-21l-21-8c-56-23-123-34-183-29"/><path fill="#b36c34" fill-rule="evenodd" d="M180 228c-13 1-17 3-19 8l-3 4c-6 3-22 24-37 47l-10 15a505 505 0 0 0-46 89 597 597 0 0 0-52 141c-9 36-9 34-8 77 1 54 1 53 26 118 14 37 36 62 68 78 29 15 70 7 96-18 14-14 35-53 41-77a492 492 0 0 1 20-61 1800 1800 0 0 0 72-176l23-64a982 982 0 0 1 29-89l4-16c6-17-4-38-25-51l-15-11c-4-4-7-6-10-6l-22-5c-10-3-10-3-38-3a1337 1337 0 0 1-94 0m685 13a157 157 0 0 0-81 55c-6 4-4 13 15 87a590 590 0 0 0 31 86l11 28c6 14 18 49 28 84a415 415 0 0 0 84 160c19 18 46 30 75 31l26 2c33 3 66-16 79-44 24-52 30-97 20-140-6-30-9-41-14-51-10-25-18-47-36-102-5-16-9-27-15-39l-10-22c-14-34-39-63-93-106-32-25-85-38-120-29M577 576c-138 14-230 156-151 231 101 98 354 47 330-76l-11-42c-7-45-95-120-168-113"/><path fill="#453123" fill-rule="evenodd" d="m549 615-16 5c-21 3-28 17-24 46 4 28 20 45 53 56l10 4-1 19c-2 25 1 32 12 32 9 0 12-6 13-23 1-15 3-29 4-29 65-18 84-63 41-100-15-13-66-18-92-10"/><path fill="#191920" fill-rule="evenodd" d="M751 537c-33 16-22 78 14 78 25-1 50-37 40-58-9-17-38-28-54-20m-367 2c-41 22-29 81 17 81 28 0 46-27 39-59-5-20-35-32-56-22"/></svg>' },
      { id: 'Sheep', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#fffaea" fill-rule="evenodd" d="M658 48c-27 2-56 21-66 42-2 7-2 7-8-1-34-41-101-30-128 20-4 7-4 7-10 1-21-20-44-23-87-9-8 3-25 12-38 21-10 7-37 34-49 48-20 24-25 34-25 52 0 11 0 11-10 12-37 3-69 13-85 26-33 28-42 102-17 140 4 6 4 6-4 8a81 81 0 0 0-63 114c11 27 22 39 51 52 12 5 14 7 13 8-51 31-70 91-45 142 10 22 40 40 74 45 12 2 12 1 7 7-30 35-33 87-6 111 31 29 75 31 134 5 12-5 11-6 10 2-5 28 19 91 29 78 2-3 108 28 108 28 3 3 41-26 50-37 4-7 4-7 9 9 9 27 25 51 43 65s57 10 97-10c34-17 35-18 34-25-1-3 111-18 113-16 4 2 44-24 58-39 37-37 47-55 48-82 0-16 0-16 4-14 16 8 43 8 60-1 43-22 60-51 60-101 0-32-1-38-15-68-10-23-9-20-3-22 25-6 47-23 53-39 18-48 1-111-39-147-8-7-8-7 4-13 28-13 38-31 37-66-3-81-24-106-86-105h-21l4-8c17-32 6-82-23-109-25-23-70-30-110-15l-11 3-2-12c-2-32-19-63-45-80-24-15-67-24-104-20"/><path fill="#c4c2c4" fill-rule="evenodd" d="M326 270c-59 13-82 71-45 111l12 13c5 6 9 9 19 13 9 4 9 3 4 11a274 274 0 0 0 58 350c188 160 481 51 489-181 1-53-6-81-43-160-7-15-7-13 2-17 51-22 64-54 41-96-28-48-118-34-120 20l-1 11-26-13c-14-8-24-12-58-26-39-16-118-30-134-24-13 5-31 11-47 15l-33 12-34 15v-6c0-16-21-40-41-48-8-3-30-3-43 0m335 615c-5 11-3 35 6 71 5 20 8 36 9 55 2 27 3 33 7 51 5 18 9 25 17 28 2 0 4 2 6 5 6 13 39 11 83-4 14-5 17-16 13-44-6-37-10-55-14-63-2-6-5-13-9-31-3-11-3-11-10-8-33 11-93-23-104-59-2-5-2-5-4-1m-290 22-36 65c-4 4-8 14-22 52l-13 31c-21 43 2 63 72 63 17 0 34-24 55-77a7452 7452 0 0 1 16-41 750 750 0 0 1 16-56h-14c-27 0-54-16-66-40-3-6-3-6-8 3"/><path fill="#202027" fill-rule="evenodd" d="M705 510c-24 13-37 67-12 75 24 7 61-1 64-27 6-50-38-55-51-48m-313 8c-20 10-27 45-11 61 24 24 80 18 75-36-2-24-42-36-64-25m218 73c-5 1-21 13-33 23-10 8-10 8-19-1-28-25-55-29-61-11-3 11 20 35 45 48 9 4 9 6 9 33 0 18 2 23 11 28 17 8 29-16 25-53-1-6 1-8 20-22 17-13 17-14 20-21 6-16-3-28-17-24"/></svg>' },
      { id: 'Koala', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#c9c9c7" fill-rule="evenodd" d="M174 148c-31 6-48 41-34 68 3 6 4 5-9 12-5 3-5 3-9 1-29-11-73 7-96 37-37 50-19 114 27 102l7-2c5 7 6 20 3 27-15 32-13 84 5 115 17 28 50 27 65-1 1-1 4 0 13 4 21 9 46 11 73 7 12-2 11-3 6 14a353 353 0 0 0 351 468c52 0 48 1 83-10a397 397 0 0 0 152-76 394 394 0 0 0 52-40c19-11 23-15 26-26 1-4 3-8 9-13 29-31 43-62 58-128a322 322 0 0 0 5-129c-2-24-6-45-11-58-2-6-2-8-1-7 5 2 24 4 37 3 15 0 15 0 22 6 23 23 70 14 88-15 10-18 14-64 8-91 0-2 0-3 6-4 23-5 37-24 38-54 2-37-17-59-60-73-13-5-16-7-21-14 0-1 1-6 4-10 15-30 5-55-25-63-44-12-76-10-110 7-13 6-13 6-24 1-12-6-24-8-33-5l-12 4c-32 6-48 43-33 76 4 7 4 7 1 13-6 13-8 22-8 40l-1 16-7-5a379 379 0 0 0-461 1c-8 6-8 6-7 1l2-14c0-9 0-9 9-18 38-39 29-108-15-119-23-6-47 0-54 14-3 4-2 4-10 1-7-2-7-2-7-8 2-34-55-65-102-55"/><path fill="#545455" fill-rule="evenodd" d="M569 595c-105 19-139 221-52 307 77 77 182-4 182-142 0-101-60-178-130-165m-160 5c-33 11-43 46-18 66a794 794 0 0 1-4-5c-14-10-11-36 5-50 18-16 46-14 52 5l2 2c0-13-22-23-37-18m323 3c-9 3-14 8-19 17-3 5-2 5 1-1 7-11 18-17 28-16h2-12m23 5c32 15 24 54-14 62-18 4-30-7-31-29 0-12 0-12-1-1 0 38 47 44 64 8 8-17-7-44-24-44l6 4m-307 16c2 3 3 6 3 14 1 9 1 9 1 1 0-9-2-17-5-19l1 4m-9 48c-6 6-5 6 1 1l5-7-6 6"/><path fill="#fffaea" fill-rule="evenodd" d="M202 276c-33 8-51 30-60 72-13 63 48 139 98 122 54-18 86-73 69-121-19-55-61-83-107-73m737 9c-52 7-102 67-91 109 20 75 118 95 167 33 45-56-6-152-76-142"/><path fill="#191920" fill-rule="evenodd" d="M405 596c-33 12-47 51-25 69l12 9c24 21 50 14 60-17 6-18 4-27-8-51-5-10-26-15-39-10m332 3c-26 9-34 56-12 71 23 16 63-6 62-36 0-22-29-42-50-35"/></svg>' },
      { id: 'Bumble_Bee', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#fffaea" fill-rule="evenodd" d="M616 127c-11 1-24 6-53 21-27 12-59 50-67 79-8 28-7 86 2 107 2 3 31 21 39 24 18 6 44 2 64-9l10-4c32-8 86-73 94-112 13-70-24-114-89-106m-316 27c-30 3-59 20-83 51-48 60-5 156 85 193 21 9 40 15 52 17 8 1 26 9 47 5l12-3c24-5 46-28 57-60 6-19-14-99-16-103-11-31-52-79-78-92-16-8-45-11-76-8m7 372c-1 0-30 42-32 41l-1 1c1 1-24 39-26 43-3 5-5 13-9 28-8 28-8 25-3 26 3 0 6 38 18 53 19 25 57 86 57 85s37 43 39 48c1 2 14 22 13 27-1 4 10 4 29 6l55-3c38-5 48 1 50-11 1-5-17-13-34-32-12-15-135-213-142-250"/><path fill="#fbefb2" fill-rule="evenodd" d="m611 345-74 13a771 771 0 0 0-79 26c0-1-37 17-40 21-11 16 18 81 29 110l52 138c11 24 109 178 114 184 6 8 8 18 21 15 84-14 159-74 198-149 7-13-1-2 0-7 0-31-131-347-159-350l-36-2-26 1m257 95c-11 5-17 27-10 38 14 22 44 13 46-13 1-16-20-31-36-25"/><path fill="#1c1c24" fill-rule="evenodd" d="M764 249c-16 5-23 26-23 69 0 15 0 15-4 15-15 3-62 9-66 15-1 4 33 56 50 91 24 49 33 69 39 85l27 63c8 17 27 80 38 115 4 14 14 0 26-6 27-14 85-74 87-77 61-71 65-166 8-221-30-28-67-50-96-56-7-1-7-4-4-24 6-36-29-57-39-23l-3 39c-1-1-17-2-17-5 2-8 6-56 4-61-5-13-18-22-27-19M421 416l-13 3c-8 1-6-1-40 29-16 13-58 65-62 77-6 20 14 74 17 84 11 31 29 82 54 126 18 33 51 83 56 90 16 23 26 44 49 51 5 1 121-14 126-15 27-5 22-11 7-30l-41-60c-21-32-96-149-120-249-7-30-19-67-19-89 0-10-1-15-5-18-3-2-2-2-9 1m447 24c-11 5-17 27-10 38 14 22 44 13 46-13 1-16-20-31-36-25M225 668l-4 19-11 59c-3 33 2 49 28 89 26 38 20 37 46 43 6 2 78 11 86 5 7-6-4-13-14-24-3-3-93-123-108-181-3-10-8-31-14-24"/></svg>' },
      { id: 'Cat', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#1c1c24" fill-rule="evenodd" d="M560 199c-63 3-130 23-182 55-7 4-7 4-14 0a229 229 0 0 0-92-35l-28-5c-20-5-54-3-62 3-24 17-25 113-4 185 5 17 15 32 29 48 6 7 6 8 4 15-5 13-12 47-14 64-1 6-1 6-13 3-52-13-83-5-83 21 0 18 26 28 75 28 19 0 18-1 18 11 1 13 1 13-42 19-27 3-39 8-52 21-30 30 3 55 47 36 7-4 18-8 24-9 9-3 12-5 21-10 8-5 8-5 10 4 2 11 3 9-13 20-49 32-75 79-52 91 13 7 27 0 53-23a150 150 0 0 1 22-18c9-6 9-6 10-2 135 309 568 329 717 31 9-18 9-18 13-14 27 23 61 24 64 1 2-11-18-32-44-46-8-4-10-11-4-21 2-3 30 0 53 5 44 10 54 8 54-10 0-25-31-39-86-39-14 0-14 0-13-10 1-15 0-14 13-16l31-7c39-8 49-15 48-29-2-23-31-32-64-21l-28 7-2-12c-1-13-6-39-9-50-3-7-3-7 7-17 42-41 57-70 61-117 9-95-11-126-79-127-45 0-95 13-134 35-11 6-11 6-21-1-72-46-152-67-239-64"/><path fill="#f9f3e2" fill-rule="evenodd" d="M736 467a18811 18811 0 0 1-36 12c-117 44-61 221 64 204 146-19 119-233-28-216m-316 4c-14 2-25 4-29 8l-9 5c-54 14-93 82-77 132 15 45 40 74 71 81 102 26 167-31 153-135-7-62-49-97-109-91m283 75c-20 7-27 38-12 51 22 20 56-3 48-32-3-13-24-23-36-19m-262 2c-15 4-28 26-24 38l4 11c9 34 53 30 61-5 6-25-19-52-41-44"/><path fill="#f19772" fill-rule="evenodd" d="M587 627c-9 5-14 11-14 17l-2 10-1 12c0 5 0 6-8 13-16 14-20 25-17 36 7 18 25 12 46-17 3-4 3-4 10 3 23 22 45 29 51 17 5-11 1-18-27-44-9-8-11-14-13-25-1-18-13-28-25-22"/></svg>' },
      { id: 'Rabbit', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#f29372" fill-rule="evenodd" d="M389 6c-29 5-50 24-66 59a271 271 0 0 0 18 147c12 43 24 72 35 86 5 7 5 7 0 9l-14 9-12 6c-2 0-7 4-17 12l-22 15c-30 20-34 25-72 79-13 19-27 60-31 88l-5 31c-7 30-9 59-9 122 1 62 5 84 22 118l10 22c6 14 25 48 32 56 11 15 55 55 74 67 23 15 22 15 81 33l45 15a286 286 0 0 0 106 17l37-8 40-8a244 244 0 0 0 102-31c20-9 40-21 54-32a567 567 0 0 0 109-151c12-25 22-56 25-80l4-24c6-25 6-30 6-47a349 349 0 0 0-16-101c-2-11-7-26-14-40l-10-25c-6-21-12-31-24-45l-15-18a334 334 0 0 0-83-76c-25-13-26-8 6-58 36-58 44-95 34-147-8-39-18-57-37-71l-12-11c-21-27-64-14-95 30-21 30-22 31-31 56-15 44-18 56-20 84a443 443 0 0 1-4 50c-1 17-1 17-6 16h-74c-7 1-7 1-8-12a644 644 0 0 0-10-86c-2-18-2-18-12-49-23-65-37-84-75-103-9-5-31-7-46-4"/><path fill="#fbfbeb" fill-rule="evenodd" d="M736 56c-15 4-27 22-42 65a367 367 0 0 1-17 41l-8 23c-4 12-8 32-13 69-1 6 0 21 2 29 5 18 38 25 61 12 41-22 74-139 57-203-6-24-24-40-40-36m-337 5c-23 5-33 38-25 79l3 22c2 15 3 21 13 51 8 23 8 26 9 36 0 11 2 15 9 25l5 8c16 30 67 11 70-26l2-15c4-15-1-55-12-101-15-59-42-87-74-79m74 568c-58 11-95 30-116 60-30 43-36 61-30 97 4 23 10 38 19 54l8 13c4 5 18 20 26 26 27 21 82 24 107 5l12-8a224 224 0 0 0 73-69c1-2 2-2 6 5a147 147 0 0 0 18 24c13 16 26 26 42 30l17 5c28 8 74 7 94-3 47-24 81-104 60-145a276 276 0 0 0-34-47c-10-15-30-27-53-34-33-10-34-10-52-9-27 1-31 1-30 4 5 9-69 7-95 0-8-2-50-12-72-8"/><path fill="#a55b00" fill-rule="evenodd" d="M584 629c-46 2-44 1-48 4-11 9-7 26 7 34 20 10 24 17 27 42 1 21 4 26 14 27 12 1 15-5 15-28 0-22 1-24 5-26 13-7 36-31 36-39 0-14-5-15-56-14"/><path fill="#191920" fill-rule="evenodd" d="M727 546c-36 17-25 70 16 73 35 3 53-62 20-73-8-3-29-3-36 0m-335-3c-25 8-38 36-28 57 20 39 78 23 78-21 0-24-26-43-50-36"/></svg>' },
      { id: 'Penguin', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#5b5b5b" fill-rule="evenodd" d="M524 190c-81 11-185 62-245 128-11 12-10 12-21 4-26-20-45-11-61 29a508 508 0 0 1-19 47l-11 26a417 417 0 0 0-36 103l-8 29-15 61a2322 2322 0 0 0-44 219c-7 33-5 40 15 54 21 17 82 29 113 23 30-6 80-35 104-60 7-7 7-7 10-4 20 22 85 64 94 59 4-1 344-18 351-12 8 6 35-11 74-46 8-7 6-8 21 7 6 6 11 9 13 10l17 7c12 6 16 8 41 16 63 22 101 19 126-10 15-16 22-47 17-67-4-12-8-40-10-63a611 611 0 0 0-16-98l-5-22c-5-35-12-63-25-94l-11-33c-6-17-10-27-18-43l-12-25a446 446 0 0 0-39-77c-20-40-40-51-59-34-4 3-4 3-26-19a431 431 0 0 0-246-119"/><path fill="#f9edd0" fill-rule="evenodd" d="M503 470c-2-2-34 8-54 17-42 18-103 62-99 73 17 59 12 162-11 206-26 51-24 45-16 58 22 36 74 86 86 81 4-1 21 14 26 15 12 4 22-5 44 15 21 18 96 21 154 6 10-2 59-20 67-23 22-7 30-34 38-30 11 5 50-35 70-71 5-8 4-10-9-34-17-34-33-103-32-140 0-19 8-64 14-83 6-21-74-73-138-89"/><path fill="#e98f13" fill-rule="evenodd" d="M542 439c-47 4-51 9-35 38 25 46 43 64 64 64 13 0 17-3 25-18l13-21a195 195 0 0 0 20-33c13-24-24-37-87-30m182 447c-20 2-38 6-41 8-21 11-28 15-34 24-4 6-4 7-6 22-1 9 8 28 16 37 15 14 28 5 30-20 1-13 2-13 9 1 19 38 49 29 40-12l-2-6 5 1c27 12 36-26 10-45-11-8-20-11-27-10m-310 19c-9 1-9 1-13 3l-12 5c-10 4-15 8-19 17-11 25 6 39 32 26l10-4-2 4c-9 17-2 43 13 46 8 1 14-4 23-19a229 229 0 0 1 7-14c2-5 2-5 4 0 11 28 35 38 45 19 5-10 3-18-7-34-4-7-6-11-5-12h-1l-10-7c-32-28-43-33-65-30"/><path fill="#191920" fill-rule="evenodd" d="M394 410c-38 13-46 74-10 82 34 7 65-27 55-61-5-17-27-27-45-21m320 2c-18 10-21 61-4 75 5 4 22 8 32 8 24 0 48-40 37-62-9-19-46-31-65-21"/></svg>' },
      { id: 'Monkey', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#704933" fill-rule="evenodd" d="M583 171a419 419 0 0 0-381 275c-20 75-20 153-16 206 5 73 23 82 53 130a416 416 0 0 0 705-12c29-49 44-62 55-132 11-74 4-72-1-129-7-71-28-105-37-124a397 397 0 0 0-378-214"/><path fill="#dbb383" fill-rule="evenodd" d="M116 369c-16 4-34 13-48 26l-18 15C17 435-3 490 4 536c4 27 21 57 44 78l14 14 27 24c12 9 61 15 87 9 4-1 15 3 15-3-11-93 2-187 21-232 7-17 9-10-5-24-22-21-62-40-91-33m918 26c-22 3-68 0-63 27 11 56 27 116 24 230 0 21 48 8 83-3 70-20 101-121 61-200-22-44-53-60-105-54m-578 22c-15 3-38 13-50 21-54 36-80 65-90 101-17 55-18 80-6 122 20 71 42 105 83 131l22 13c18 12 58 25 81 28a825 825 0 0 0 238-10c29-9 29-9 68-45l18-16c3-2 19-22 23-28a202 202 0 0 0 22-83 181 181 0 0 0-12-111c-8-23-11-28-19-41-65-97-185-104-230-12-5 10-5 10-10 0-10-20-35-46-54-55-20-11-68-19-84-15"/><path fill="#191920" fill-rule="evenodd" d="M723 537c-17 7-27 46-15 61 14 16 50 10 60-11 16-31-22-59-45-50m-283 9c-23 12-34 46-10 58 4 2 14 10 22 11 11 2 31-12 37-25 13-31-20-58-49-44m129 67c-31 6-26 38 7 40 10 0 10 0 10 18 0 24 3 29 14 29 10 0 13-7 13-31 0-19 0-19 16-19 21-1 28-6 26-18-2-14-11-19-40-19a965 965 0 0 1-46 0"/></svg>' },
      { id: 'Whale', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#4c6484" fill-rule="evenodd" d="M556 331c-5 16-25 20-41 3-15-16-108 20-157 59-241 192-37 571 266 495l29-5 28-7 25-8a567 567 0 0 0 113-50 316 316 0 0 0 98-82c19-20 36-40 49-60 6-10 8-13 15-34 0-1 2 0 5 3 25 22 91 19 128-5 36-24 51-51 44-83l-2-16c-2-16-13-44-22-54-21-25-77-16-118 18-5 4-5 4-6-1-2-13-20-50-29-59-25-27-53-28-88-2-32 25-35 72-6 109 6 8 6 9 0 9a362 362 0 0 0-51 9l-2-12c-20-94-93-177-185-211-35-13-91-23-93-16"/><path fill="#fbfbeb" fill-rule="evenodd" d="M633 164c-36 3-59 7-72 14-10 5-53 5-83 0-55-10-70-7-74 14-6 28 17 44 67 44 10 0 27 2 31 4 3 0 4 22 4 55-1 33 0 37 9 44 16 15 38 16 44 3 2-3 3-5 2-16l2-21c2-13 2-21 1-38 0-22 0-22 19-27 55-17 65-21 78-34 24-24 10-44-28-42M367 605c-42 8-37 67 5 68 35 0 43-61 9-68-7-2-7-2-14 0"/></svg>' },
      { id: 'Axolotl', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#fba373" fill-rule="evenodd" d="M575 255a401 401 0 0 0-190 64c-22 14-23 15-39 37-7 9-16 22-22 28-11 12-11 12-7 20s-4 7-2 12c1 3-28 9-35 1-4-4-52-39-51-42 17-40-25-23-48-28-5-1-26 25-22 37 3 13 13 44 26 60 17 21-27 93-79 84-13-3-34 2-35 6-1 2-3 36-1 39 7 10 47 31 90 33 20 1 36 66 21 74-12 6-51 41-55 43-32 25 28 58 63 35 3-2 56-26 69-34 9-7 65 16 42 35-10 8-10 8-6 16l13 25c17 33 59 68 116 96 169 81 381 23 479-132 7-12 34-64 38-61l22 15c16 13 53 3 69-5 13-6 5-37-26-54-5-3-37-33-40-35-35-20 17-27 31-28 10-2 83-12 95-16 7-2 20-37 18-43-5-21-54-48-112-40-15 2-62-15-49-28 6-6 37-49 43-56 20-23 18-45 10-51-11-8-45-18-89 19-17 14-82 36-57 1 10-13 10-10-1-23-52-65-180-113-279-104"/><path fill="#e40444" fill-rule="evenodd" d="M977 296c-39 9-94 47-117 80-19 27-23 34-26 47s0 25 9 32l9 8c11 11 21 8 25-7 2-10 20-32 37-46 45-37 67-49 78-41 8 6 6 11-14 35a1586 1586 0 0 0-43 49 318 318 0 0 0-36 41c-11 13-6 35 9 39h31a2916 2916 0 0 1 59-7c59-8 96-1 102 20 1 7-10 23-18 26-11 3-27 5-48 5l-36 2c-15 2-16 2-30 0-46-6-65 0-65 20 0 14 9 23 44 43a408 408 0 0 1 38 23c31 17 48 40 35 46-16 8-41 3-57-10l-13-9-46-45c-9-11-13-13-26-12-34 0-40 22-15 62l10 16c35 59 102 84 148 57l15-7c47-16 55-56 20-110-5-8-5-8 3-10 68-20 101-53 101-100 0-40-2-44-27-62s-22-17-86-20c-27 0-26 1-10-17 27-32 33-51 26-85-5-27-8-31-34-47l-12-8c-11-8-26-11-40-8m-782 8c-39 6-67 32-64 58l2 22c1 20 16 57 34 84 10 14 12 19 10 18a3859 3859 0 0 1-82-3c-61-4-111 63-83 110 18 31 58 50 120 55 8 1 8 1-2 7-39 27-53 45-53 73l-1 21c-3 53 64 82 132 57l14-4a152 152 0 0 0 43-21l16-8c31-18 54-48 54-71 0-17-23-29-36-18l-10 5-31 19a255 255 0 0 1-40 23c-35 24-104 17-71-8 3-2 10-7 13-11 5-4 11-8 23-14a460 460 0 0 0 55-32c15-7 22-19 22-37 0-12-13-27-29-32l-8-4-7-3-17-4c-13-4-14-4-34-5-43-2-83-11-89-21-2-3-6-15-5-17 1-3 21-4 34-2a792 792 0 0 0 110 16c24 4 28 3 39-7 18-18 17-37-3-57a1089 1089 0 0 0-60-77c-14-15-13-14-16-26-4-13-3-19 3-18 22 5 31 8 38 14 2 3 8 7 13 10 9 6 18 15 27 27l12 15c7 8 15 19 24 35 13 22 24 30 34 25l6-2c20 0 21-26 2-54l-6-11a196 196 0 0 0-34-63c-37-51-65-69-99-64"/><path fill="#191920" fill-rule="evenodd" d="M742 568c-13-1-31 1-29 37 1 33 47 44 62 13 15-32-5-59-33-50m-323 2c-14 7-19 15-19 32 0 34 28 48 55 27 6-5 12-21 12-32 0-9-8-18-19-24-10-5-21-7-29-3m121 109c-19 5-27 25-16 38 17 19 112 18 121-1 10-21-5-33-45-34-13 0-30-2-36-3-13-2-16-2-24 0"/></svg>' },
      { id: 'Red_Panda', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#eb8c15" fill-rule="evenodd" d="M571 210c-43 4-68 5-112 17-12 3-22 9-33 14a662 662 0 0 0-164 103c-17 19-27 37-44 55-4 5-10 9-14 15l-1 8c-3 8-7 16-12 23-2 3-7 4-8 7a521 521 0 0 0-27 264c9 40 34 74 53 111 5 9 12 18 20 26 54 60 71 90 144 118 36 13 85 29 122 37 21 5 44 2 66 2a580 580 0 0 0 221-55 325 325 0 0 0 137-121c5-6 35-47 41-61 31-70 31-125 35-208 1-18-9-85-12-94-3-14-10-27-17-40-2-4-7-6-9-10-4-6-2-15-7-21-10-9-19-27-28-36-26-26-45-45-73-69-3-3-9-1-12-4-17-11-31-27-48-38-64-39-146-41-218-43"/><path fill="#453123" fill-rule="evenodd" d="M933 252c-17 6-31 5-44 14-31 22-40 29-47 32s1 10 6 14c15 11 47 52 50 55l24 27c20 23 30 31 30 25 1-8 9-4 14-11 13-20 40-55 43-65 4-14-4-67-8-77-11-26-35-31-65-21m-763 9c-32 5-37 39-14 90l20 47c7 13 25 23 24 25l18-20a444 444 0 0 1 56-59c16-15 20-19 17-19-7 0-18-26-36-45-16-16-62-25-82-21m304 350c-8 4-17 6-19 6-16 1-52 10-48 15 6 9 4 13-8 24-12 13-26 40-31 56-1 4-14 27-16 34-20 70 16 153 77 175l66 25c12 5 130 1 134 0 46-12 101-42 114-66 30-58 32-157-6-198-7-7-26-18-32-24-5-7-15-23-12-30 2-3-11-6-11-6-4-3-48-15-49-14l5 8c3 4-148-11-149-11l-15 6"/><path fill="#fffaea" fill-rule="evenodd" d="M932 184a212 212 0 0 0-53 23l-13 5c-52 17-81 59-57 84 18 20 30 17 80-19 68-49 112-37 112 30 0 22-10 46-42 96-4 7-7 24-4 30 36 86 133-87 99-177-22-61-67-87-122-72m-763 7c-54 6-87 59-73 119l3 20c4 38 16 68 40 100 41 56 83 12 47-50l-19-41c-15-34-15-65-2-73 27-16 64-6 95 25 20 20 28 25 39 24 17-2 29-11 29-22l2-6c4-5-12-34-26-49-29-32-88-53-135-47m396 369c-67 7-116 86-116 187 0 34 3 54 12 74l6 16c17 53 104 80 151 49 35-24 58-60 63-98 5-34 3-83-4-103-24-67-52-109-82-122-11-4-13-5-30-3m129 51c-16 8-12 18 30 61 41 43 49 121 20 183-13 28-54 54-110 71l-16 5a225 225 0 0 1-149-16l-18-9c-60-26-95-103-78-167l8-27c5-19 18-42 33-59 11-12 14-19 10-26-10-19-33-9-65 29l-21 22c-21 21-40 68-43 105-5 85 93 168 218 184 97 12 207-13 255-59 65-63 75-112 42-197a195 195 0 0 0-83-93c-10-7-25-10-33-7m-142 16c-26 5-40 25-32 46 4 11 6 14 17 19 13 6 12 4 12 36s3 38 19 36c16-1 21-22 17-61-1-5-1-5 8-9 51-24 18-79-41-67"/><path fill="#191920" fill-rule="evenodd" d="M370 522c-32 10-46 54-24 74 33 29 77 8 77-37 0-27-27-46-53-37m366 5c-27 12-32 47-11 71 24 29 75 7 75-32 0-30-36-52-64-39" style="stroke-width:1"/></svg>' },
      { id: 'Panda', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#fbfbeb" fill-rule="evenodd" d="M535 257c-29 5-70 9-98 22-60 27-102 56-144 107-4 4-34 40-38 49-14 36-25 72-37 108-2 5-2 10-2 15-7 54-12 118 4 170 14 43 40 83 66 120 66 90 174 144 285 142 29 0 57 1 85-4 47-8 88-29 129-51 18-9 38-13 53-27 43-42 85-87 117-138 56-93 27-228-20-319-14-29-36-55-55-82-8-12-43-44-46-45-6-5-13-8-20-11l-52-24c-65-28-156-30-227-32"/><path fill="#1c1c24" fill-rule="evenodd" d="M272 254c-51 12-122 71-133 111-11 36-12 76-4 101 8 22 34 58 56 76 6 4 11 8 11 10 7 13 14 9 16-9 3-31 32-97 53-130s45-58 63-72c20-16 37-28 46-32s10-5 7-10c-5-11-18-20-37-28l-15-7c-18-9-49-14-63-10m608 22c-18 5-40 16-57 29-10 9-10 8 4 15 13 7 25 22 39 38 4 5 39 49 55 77 16 26 23 36 32 61l18 51c3 18 4 19 14 14 23-12 51-59 58-98 15-86-2-132-68-176-17-12-69-18-95-11M435 464c-50 7-101 42-135 92-91 139 36 247 164 140 111-93 91-250-29-232m332 2c-92 16-108 151-27 233 79 80 187 42 187-67 0-94-82-179-160-166M601 685l-22 1c-50 1-49 41 1 78 4 3 4 3 3 26-2 32 0 39 14 39 13 0 18-12 18-42 0-20 0-20 11-24 12-5 21-10 26-17 28-38 4-68-51-61"/></svg>' },
      { id: 'Bear', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#774623" d="M645 263c47 11 75 15 120 33 31 13 41 30 55 28 16-2 23-24 39-29 47-17 62-15 100-9 15 2 36 21 47 32 3 3 35 58 35 62 6 56 6 72-10 115-8 21-34 38-49 54l-10 9c-2 2-7 1-8 4-2 5-1 10-1 15-1 38 5 77-2 114-6 36-14 73-35 102-104 138-155 179-338 196-98 9-170-31-233-79-67-52-97-96-125-214-11-43 0-88 1-132l5-20-3-2c-22-11-38-17-52-44-15-32-17-32-17-84 0-12-10-39 12-70 39-55 73-56 116-65 26-6 52 13 75 25 9 4 13 15 19 23 2 2 2 6 4 6 5-1 10-5 15-8 16-10 30-22 47-29 42-15 85-29 129-37 21-3 43 0 64 4Z"/><path fill="#EAD7BA" d="M729 654c10 11 31 32 41 63 17 56 14 73-4 113-13 27-18 34-43 58-5 5-16 15-39 22-43 13-91 28-134 16-45-13-81-32-118-79-17-21-19-50-21-76-1-19 7-36 12-54 12-48 48-89 93-102 78-22 166-12 213 39Z"/><path fill="#2C2016" d="M596 629c22 1 42 5 63 10l28 17c17 14 18 41-4 58-15 12-18 16-35 26l-31 16c0 7 0 33-2 40-6 21-1 40-23 42-22 3-13-61-15-77 0-1-9-2-11-4-29-18-49-37-70-67-3-4-6-19-3-23 39-44 87-40 103-38Z"/><path fill="#1A1920" d="M390 579c8-17 40-10 41-9 0 1 19 9 23 16 10 23-1 39-20 49-9 4-34-1-41-6-9-8-4-48-3-50ZM782 574c12 11 19 34 8 49-6 6-14 9-22 12-32 12-59-54-21-66 9-3 26-3 35 5Z"/></svg>' },
      { id: 'Pig', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#ffc5b3" fill-rule="evenodd" d="M593 244c-66 7-109 19-161 44-18 9-212 91-221 301-7 170 83 331 250 387 262 88 552-104 546-369-4-149-59-257-201-321-63-29-150-49-213-42"/><path fill="#211f26" fill-rule="evenodd" d="M761 581c-22 7-36 35-27 53 13 28 45 36 67 16 33-30 2-83-40-69m-326 1c-35 10-42 52-13 72s62 3 65-33c2-27-24-47-52-39"/><path fill="#fc8369" fill-rule="evenodd" d="M336 246c-81 11-122 73-160 136-33 54-22 111-11 151 9 30 56 45 83 54l25 8c76 28 179-6 185-72 5-63 6-70 0-91-15-58-24-142-83-179-11-7-26-5-39-7m531 12c-8 4-17 6-25 11-11 9-20 20-27 32-49 73-67 125-42 234 7 29 36 52 64 63 34 13 100-15 134-30 11-4 75-29 77-48 8-79 13-73-29-160-9-19-54-89-152-102M599 639c-25 5-29-2-94 23-59 23-86 55-118 93-53 62 4 138 66 162 17 7 37 1 56 0 18-2 35-10 53-11 30-2 61-3 92-3 40-1 83 17 119 0 50-24 79-68 47-149-4-9-19-35-22-38-30-35-84-59-126-69-23-6-48-5-73-8m58 86c-4 15-12 30-13 45-3 39 11 51 21 43 18-15 14-56 11-85 0-6-3-3-19-3m-128 3c-3 25-16 53-7 77 4 11 30-1 32-12 6-45 8-71-25-65"/></svg>' },
      { id: 'Unicorn', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#fffaea" fill-rule="evenodd" d="M301 58c-38 11-70 97-60 164 7 50 17 77 44 122 11 19 11 45 12 26 1-15 125-73 136-68 3 2 0-23 2-26a583 583 0 0 0-70-172c-26-44-39-53-64-46m626 1c-15 2-32 19-43 34-30 42-75 127-78 134-10 22-18 46-25 78-2 7-1 7-15 1-56-25-516 143-530 147-10 3 27 329 34 341 93 175 321 260 500 174a366 366 0 0 0 119-571c-7-8-7-7 5-15 47-30 74-62 88-103 16-49 16-70 1-137 0-3-22-57-25-62-9-18-17-24-31-21"/><path fill="#ff9a75" fill-rule="evenodd" d="m436 275-88 32c-21 13-33 39-52 54-10 8-19 4-29 16-15 17-14 34-32 48-15 11-38 15-48 31-10 17-6 39-6 58 0 7 11 13 7 18-12 18-37 25-48 44-14 25 20 57 27 78 3 9 0 20 4 29 6 14 16 25 26 37 1 1 6-1 5 1-3 12-14 23-15 36-1 17 10 57 12 60 13 14 26 28 41 41 3 3 9 8 13 6 10-7 20-18 24-30 3-10-5-21-4-32 1-5 11-3 15-7 7-8 15-16 19-26 3-5 12-69 10-74-1-4 135-419 140-426 8-10-14 2-21 6"/><path fill="#48d7ad" fill-rule="evenodd" d="M461 257c-21 16-30 26-45 48-12 20-21 45-38 63-9 9-22 15-29 26-7 10-9 24-12 36-1 2 3 5 1 7-8 10-39 14-43 26-7 20 12 43 13 64 0 2 3 4 2 6l-8 11c-11 18-26 35-32 55-2 8 9 14 9 21 0 2-27 83-13 87 20 7 37-17 56-25 22-9 33 5 60-19 12-10 14-46 16-48 10-12 29-18 34-33 6-21-5-44-4-66 0-9 23-20 29-27 1-1-4-24-7-34-4-12-11-24-13-37-2-11 0-22 2-33 1-14 13-51 15-56 7-14 41-39 45-54 9-28-20-15-38-18"/><path fill="#ffc5b3" fill-rule="evenodd" d="M616 281c-3 6-66 6-72 0a299 299 0 0 0 2 62l4 255s5 43-1 44c-72 11-133 88-128 163 10 147 196 218 300 114a172 172 0 0 0-13-249c-12-9-49-24-65-27-9-1-8 1-6-20a82847 82847 0 0 0 29-219c12-97 13-105 11-112M518 807c-13 8-10 21 13 55 11 17 23 21 32 12 9-10 8-14-10-43-16-26-23-31-35-24m141 1c-5 3-7 6-19 28-12 21-12 29-1 37s22 1 36-28c15-29 5-50-16-37"/><path fill="#fde57c" fill-rule="evenodd" d="M606 27c-12 4-20 18-26 45l-6 24c-11 45-18 84-22 123-2 24-3 50-5 61-1 5 14 26 22 28 6 1 81 2 85 0 8-3 16-13 19-23l2-6c7-8 6-47-2-98a509 509 0 0 0-31-123c-8-26-21-37-36-31"/><path fill="#a796c5" fill-rule="evenodd" d="M492 259c-15 16-30 55-38 70-2 5-7 10-8 15-4 21-9 42-6 63 2 14 13 25 19 38 1 2 3 4 2 7 0 12-9 24-5 35 17 46 24 43 46 62 19 16 31 47 56 48 42 1 29-62 31-79 3-27 12-53 13-80 0-6-5-12-9-17-3-3-9-2-11-5-3-8 2-17-1-24-7-16-17-29-27-43-2-3 2-97 1-101"/><path fill="#191920" fill-rule="evenodd" d="M423 595c-30 7-35 56-7 70 33 17 58 2 58-33 0-29-22-45-51-37m331 2c-24 8-32 46-13 63 28 24 65 9 67-26 2-26-27-45-54-37"/></svg>' },
      { id: 'Bat', svg: '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path fill="#1c1b23" d="m592 6-11 7c-9 7-86 49-176 65-63 11-108 3-141-16-23-13-23-13-28-13-4 0-18 6-22 10-7 5-8 15-3 28 12 28 17 125-41 188-60 64-109 93-127 97-27 5-26 21-6 48 60 83 61 74 133 115 12 7 95 19 95 20l-2 11a273 273 0 0 0 271 324c10 0 10 0 9 3-3 64-4 64 4 97 19 76 75 131 76 133 16 30 39 34 51 9 10-22 43-59 89-85 93-54 193-39 226-16 16 10 24 10 34-3 11-13 11-14 4-36-12-40-9-78 10-135 10-30 17-44 45-85 39-59 43-66 63-85 44-43-26-65-112-45-43 10-101 29-108 55-28 110-128 182-222 161-13-3-29-9-27-10l10-7a268 268 0 0 0 112-242l10-8c40-29 74-88 78-132 7-77-5-81-85-35-49 28-60 32-70 22-10-12-45-39-42-45 5-12 70-117 40-133-9-5-13-2-25-2-38 0-108 39-158 87-10 10-10 10-32 11-70 0-132 26-181 74l-11 9c-2-3-5-22-6-35-3-99 88-183 202-188 31-1 45-15 69-67l15-29c27-46 33-80 19-107-8-16-18-22-29-15"/><path fill="#e1041c" d="M501 460c-23 10-32 44-15 62 34 33 90-16 58-51-9-10-31-16-43-11m135 122c-21 3-36 31-28 49 11 26 55 30 71 7 11-17 4-41-15-50-12-6-19-8-28-6"/></svg>' }
    ],
    // { id: 'Pig', svg: '<svg>...</svg>' },
    // { id: 'Bat', svg: '<svg>...</svg>' }


    // Yarn requirements
    YARN_PER_SQUARE: {
      background: 14,          // when square has an animal
      backgroundNoAnimal: 20,  // when square has no animal
      border: 8
    },
    
    // Animal yarn data (in meters per animal)
    ANIMAL_YARN: {
      "Axolotl": { "Light Pink": 10, "Vibrant Pink": 5, "Black": 0.5 },
      "Bat": { "Black": 14, "Blood Orange": 1 },
      "Bear": { "Brown": 10, "Light Brown": 2, "Dark Brown": 1, "Black": 0.5 },
      "Bumble_Bee": { "Yellow": 6, "Black": 6, "White": 6 },
      "Cat": { "Black": 10, "White": 5, "Pink": 1 },
      "Dog": { "Medium Brown": 12, "Light Brown": 7, "Dark Brown": 1, "Black": 0.5 },
      "Duck": { "Yellow": 10, "Orange": 5, "Black": 1 },
      "Elephant": { "Purple": 14, "Pink": 5, "White": 1, "Black": 0.5 },
      "Giraffe": { "Yellow": 15, "Brown": 5, "Black": 0.5 },
      "Highland_Cow": { "Brown": 12, "Light Brown": 2, "Medium Brown": 1, "Black": 0.5 },
      "Koala": { "Grey": 10, "Dark Grey": 5, "White": 5, "Black": 0.5 },
      "Lion": { "Yellow": 9, "Orange": 8, "White": 5, "Brown": 1,  "Black": 0.5 },
      "Monkey": { "Brown": 8, "Light Brown": 6, "Black": 0.5 },
      "Owl": { "Taupe": 20, "Light Brown": 10, "White": 1, "Yellow": 1, "Black": 0.5 },
      "Panda": { "White": 7, "Black": 5 },
      "Penguin": { "Grey": 14, "White": 5, "Orange": 1, "Black": 0.5 },
      "Pig": { "Pink": 7, "Dark Pink": 7, "Black": 0.5 },
      "Rabbit": { "Pink": 8, "White": 5, "Brown": 1, "Black": 0.5 },
      "Red_Panda": { "Orange": 7, "White": 7, "Brown": 5, "Black": 0.5 },
      "Sheep": { "White": 14, "Grey": 9, "Black": 0.5 },
      "Tiger": { "Orange": 10, "Brown": 5, "White": 5, "Black": 0.5 },
      "Unicorn": { "White": 12, "Light Pink": 7, "Purple": 5, "Blue": 5, "Pink": 5, "Yellow": 5, "Black": 0.5 },
      "Whale": { "Blue": 14, "White": 1 },
    },
    
    // Hex color to friendly name mapping
    COLOR_NAMES: {
      '#ebad93': 'Light Pink',
      '#c9a68d': 'Light Brown',
      '#93c3eb': 'Light Blue',
      '#849587': 'Green',
      '#f0ead5': 'Cream',
      '#506584': 'Blue',
      '#495f4a': 'Dark Green',
      '#cd896d': 'Pink',
      '#e1c8a7': 'Brown'
    },
    
    // Blanket dimensions
    SQUARE_SIZE_CM: 13,
    SQUARE_SIZE_IN: 5,
    JOIN_GAP_CM: 0.8
  };

  // ============================================================
  // STATE MANAGEMENT MODULE
  // ============================================================
  const State = {
    // Current tool selection
    selection: {
      bg: '#ffffff',
      border: 'transparent',
      iconId: null,  // Store icon ID for export (null means no icon)
      iconSvg: ''    // Store SVG string for rendering
    },
    
    // Edit mode: 'all' | 'color' | 'pattern'
    editMode: 'all',
    
    // Grid dimensions
    grid: {
      cols: 5,
      rows: 6
    },
    
    // History stacks with limit
    undoStack: [],
    redoStack: [],
    
    // Painting state
    isPainting: false,
    currentBulkAction: [],
    
    // Track if any changes made (for clear button)
    hasChanges: false,

    // Push to undo with limit enforcement
    pushUndo(action) {
      this.undoStack.push(action);
      // Enforce stack limit
      if (this.undoStack.length > Config.UNDO_STACK_LIMIT) {
        this.undoStack.shift(); // Remove oldest action
      }
      this.redoStack = []; // Clear redo on new action
      this.hasChanges = true;
    },

    // Pop from undo
    popUndo() {
      return this.undoStack.pop();
    },

    // Push to redo with limit
    pushRedo(action) {
      this.redoStack.push(action);
      if (this.redoStack.length > Config.UNDO_STACK_LIMIT) {
        this.redoStack.shift();
      }
    },

    // Pop from redo
    popRedo() {
      return this.redoStack.pop();
    },

    // Clear history
    clearHistory() {
      this.undoStack = [];
      this.redoStack = [];
      this.hasChanges = false;
    },

    // Update selection
    setSelection(key, value) {
      this.selection[key] = value;
    },
    
    // Set icon selection (both id and svg)
    setIconSelection(iconId, iconSvg) {
      this.selection.iconId = iconId;
      this.selection.iconSvg = iconSvg;
    },

    // Update grid dimensions
    setGridSize(cols, rows) {
      this.grid.cols = cols;
      this.grid.rows = rows;
    }
  };

  // ============================================================
  // UTILITY MODULE
  // ============================================================
  const Utils = {
    // Debounce function
    debounce(fn, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    },

    // Parse layout string to dimensions
    parseLayout(layoutStr) {
      const [cols, rows] = layoutStr.split('x').map(Number);
      return { cols, rows };
    },

    // Convert linear index to row/col coordinates
    indexToCoords(index, cols) {
      return {
        row: Math.floor(index / cols),
        col: index % cols
      };
    },

    // Convert row/col to linear index
    coordsToIndex(row, col, cols) {
      return row * cols + col;
    },
    
    // Find icon by ID
    getIconById(iconId) {
      if (!iconId) return null;
      return Config.ICON_SVGS.find(icon => icon.id === iconId) || null;
    },
    
    // Find icon ID by SVG string (for backwards compatibility)
    getIconIdBySvg(svgString) {
      if (!svgString) return null;
      const icon = Config.ICON_SVGS.find(icon => icon.svg === svgString);
      return icon ? icon.id : null;
    },

    // Lazy load html2canvas
    _html2canvasPromise: null,
    
    async loadHtml2Canvas() {
      if (this._html2canvasPromise) {
        return this._html2canvasPromise;
      }
      
      this._html2canvasPromise = new Promise((resolve, reject) => {
        // Check if already loaded
        if (window.html2canvas) {
          resolve(window.html2canvas);
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = () => resolve(window.html2canvas);
        script.onerror = () => reject(new Error('Failed to load html2canvas'));
        document.head.appendChild(script);
      });
      
      return this._html2canvasPromise;
    }
  };

  // ============================================================
  // DOM REFERENCES
  // ============================================================
  const DOM = {
    closeBtn: document.getElementById('closeBtn'),
    hint: document.getElementById('hint'),
    toggleBtn: document.getElementById('toggleControlsBtn'),
    header: document.getElementById('header'),
    controls: document.getElementById('controls'),
    grid: document.getElementById('grid'),
    gridInner: document.getElementById('gridInner'),
    layoutSelect: document.getElementById('layout'),
    bgPalette: document.getElementById('bgPalette'),
    borderPalette: document.getElementById('borderPalette'),
    bgColorInput: document.getElementById('bgColor'),
    borderColorInput: document.getElementById('borderColor'),
    iconGrid: document.getElementById('iconGrid'),
    undoBtn: document.getElementById('undoBtn'),
    redoBtn: document.getElementById('redoBtn'),
    menuBtn: document.getElementById('menuBtn'),
    dropdownMenu: document.getElementById('dropdownMenu'),
    saveJsonBtn: document.getElementById('saveJsonBtn'),
    loadJsonBtn: document.getElementById('loadJsonBtn'),
    loadJsonInput: document.getElementById('loadJsonInput'),
    yarnQuantitiesBtn: document.getElementById('yarnQuantitiesBtn'),
    yarnModal: document.getElementById('yarnModal'),
    yarnModalBody: document.getElementById('yarnModalBody'),
    yarnModalClose: document.getElementById('yarnModalClose'),
    yarnTotal: document.getElementById('yarnTotal'),
    clearBtn: document.getElementById('clearBtn'),
    applyAllBtn: document.getElementById('applyAllBtn'),
    randomizeBtn: document.getElementById('randomizeBtn'),
    exportBtn: document.getElementById('exportBtn'),
    shareLinkBtn: document.getElementById('shareLinkBtn'),
    shareModal: document.getElementById('shareModal'),
    shareUrlInput: document.getElementById('shareUrlInput'),
    copyShareUrlBtn: document.getElementById('copyShareUrlBtn'),
    shareCopyStatus: document.getElementById('shareCopyStatus'),
    shareModalClose: document.getElementById('shareModalClose')
  };

  // ============================================================
  // GRID MODULE
  // ============================================================
  const Grid = {
    // Snapshot a single square's state (includes iconId for export)
    snapshotSquare(square) {
      const iconNode = square.querySelector('svg');
      return {
        square,
        bg: square.style.backgroundColor || Config.DEFAULT_SQUARE_BG,
        border: square.style.borderColor || Config.DEFAULT_SQUARE_BORDER,
        iconId: square.dataset.iconId || null,
        iconSvg: iconNode ? iconNode.outerHTML : ''
      };
    },

    // Snapshot entire grid with coordinates (for layout changes and export)
    snapshotGridWithCoords() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const snapshot = [];
      const { cols, rows } = State.grid;
      
      squares.forEach((square, index) => {
        const { row, col } = Utils.indexToCoords(index, cols);
        const iconNode = square.querySelector('svg');
        snapshot.push({
          row,
          col,
          bg: square.style.backgroundColor || Config.DEFAULT_SQUARE_BG,
          border: square.style.borderColor || Config.DEFAULT_SQUARE_BORDER,
          iconId: square.dataset.iconId || null,
          iconSvg: iconNode ? iconNode.outerHTML : ''
        });
      });
      
      return {
        cols,
        rows,
        squares: snapshot
      };
    },

    // Apply style to a square
    applyToSquare(square, record = true) {
      if (record) {
        State.pushUndo([this.snapshotSquare(square)]);
        UI.updateUndoRedoButtons();
      }
      
      if (State.editMode === 'all' || State.editMode === 'color') {
        square.style.backgroundColor = State.selection.bg;
        square.style.borderColor = State.selection.border;
      }
      
      if (State.editMode === 'all' || State.editMode === 'pattern') {
        square.innerHTML = '';
        square.dataset.iconId = '';  // Clear icon ID
        
        if (State.selection.iconSvg) {
          square.innerHTML = State.selection.iconSvg;
          square.dataset.iconId = State.selection.iconId || '';
        }
      }
      
      State.hasChanges = true;
    },

    // Restore a square from snapshot
    restoreSquare(snapshot) {
      const { square, bg, border, iconId, iconSvg } = snapshot;
      square.style.backgroundColor = bg;
      square.style.borderColor = border;
      square.innerHTML = iconSvg || '';
      square.dataset.iconId = iconId || '';
    },

    // Create grid with position-preserving resize
    createGrid(newCols, newRows, preserveContent = true) {
      const gridInner = DOM.gridInner;
      
      // Capture current state before resize (for undo and content preservation)
      let previousSnapshot = null;
      if (preserveContent && gridInner.children.length > 0) {
        previousSnapshot = this.snapshotGridWithCoords();
      }

      // Update state
      State.setGridSize(newCols, newRows);
      
      // Setup grid CSS
      gridInner.style.display = 'grid';
      gridInner.style.gridTemplateColumns = `repeat(${newCols}, minmax(76px, 116px))`;
      gridInner.innerHTML = '';

      // Create squares
      const totalSquares = newCols * newRows;
      for (let i = 0; i < totalSquares; i++) {
        const square = document.createElement('div');
        square.className = 'square';
        square.dataset.index = i;
        square.dataset.iconId = '';  // Initialize iconId data attribute
        
        // Apply preserved content if available
        if (previousSnapshot) {
          const { row, col } = Utils.indexToCoords(i, newCols);
          const preserved = previousSnapshot.squares.find(
            s => s.row === row && s.col === col
          );
          
          if (preserved) {
            square.style.backgroundColor = preserved.bg;
            square.style.borderColor = preserved.border;
            square.dataset.iconId = preserved.iconId || '';
            if (preserved.iconSvg) {
              square.innerHTML = preserved.iconSvg;
            }
          }
        }
        
        gridInner.appendChild(square);
      }

      // Record layout change for undo (if we had previous content)
      if (previousSnapshot) {
        State.pushUndo({
          type: 'layout',
          before: previousSnapshot,
          after: this.snapshotGridWithCoords()
        });
        UI.updateUndoRedoButtons();
      }
    },

    // Restore grid from a layout snapshot (for undo/redo)
    restoreFromLayoutSnapshot(snapshot) {
      const { cols, rows, squares } = snapshot;
      
      State.setGridSize(cols, rows);
      DOM.layoutSelect.value = `${cols}x${rows}`;
      
      const gridInner = DOM.gridInner;
      gridInner.style.gridTemplateColumns = `repeat(${cols}, minmax(76px, 116px))`;
      gridInner.innerHTML = '';
      
      for (let i = 0; i < cols * rows; i++) {
        const square = document.createElement('div');
        square.className = 'square';
        square.dataset.index = i;
        square.dataset.iconId = '';
        
        const { row, col } = Utils.indexToCoords(i, cols);
        const preserved = squares.find(s => s.row === row && s.col === col);
        
        if (preserved) {
          square.style.backgroundColor = preserved.bg;
          square.style.borderColor = preserved.border;
          square.dataset.iconId = preserved.iconId || '';
          if (preserved.iconSvg) {
            square.innerHTML = preserved.iconSvg;
          }
        }
        
        gridInner.appendChild(square);
      }
    },

    // Clear all squares
    clearAll() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const snapshot = Array.from(squares).map(s => this.snapshotSquare(s));
      State.pushUndo(snapshot);
      
      squares.forEach(square => {
        if (State.editMode === 'all' || State.editMode === 'color') {
          square.style.backgroundColor = Config.DEFAULT_SQUARE_BG;
          square.style.borderColor = Config.DEFAULT_SQUARE_BORDER;
        }
        
        if (State.editMode === 'all' || State.editMode === 'pattern') {
          square.innerHTML = '';
          square.dataset.iconId = '';
        }
      });
      
      State.hasChanges = false;
      UI.updateUndoRedoButtons();
    },

    // Apply current selection to all squares
    applyToAll() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const snapshot = Array.from(squares).map(s => this.snapshotSquare(s));
      State.pushUndo(snapshot);
      
      squares.forEach(square => this.applyToSquare(square, false));
      UI.updateUndoRedoButtons();
    },

    // Randomize grid
    randomize() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const snapshot = Array.from(squares).map(s => this.snapshotSquare(s));
      State.pushUndo(snapshot);

      squares.forEach(square => {
        if (State.editMode === 'all' || State.editMode === 'color') {
          const randomBG = Config.PRESET_BG_COLORS[
            Math.floor(Math.random() * Config.PRESET_BG_COLORS.length)
          ];
          const randomBorder = Config.PRESET_BORDER_COLORS[
            Math.floor(Math.random() * Config.PRESET_BORDER_COLORS.length)
          ];
          square.style.backgroundColor = randomBG;
          square.style.borderColor = randomBorder;
        }

        if (State.editMode === 'all' || State.editMode === 'pattern') {
          square.innerHTML = '';
          square.dataset.iconId = '';
          
          if (Math.random() >= 0.5 && Config.ICON_SVGS.length > 0) {
            const randomIcon = Config.ICON_SVGS[
              Math.floor(Math.random() * Config.ICON_SVGS.length)
            ];
            square.innerHTML = randomIcon.svg;
            square.dataset.iconId = randomIcon.id;
          }
        }
      });

      State.hasChanges = true;
      UI.updateUndoRedoButtons();
    }
  };

  // ============================================================
  // HISTORY MODULE
  // ============================================================
  const History = {
    undo() {
      const lastAction = State.popUndo();
      if (!lastAction) return;

      // Handle layout change
      if (lastAction.type === 'layout') {
        const currentSnapshot = Grid.snapshotGridWithCoords();
        State.pushRedo({
          type: 'layout',
          before: currentSnapshot,
          after: lastAction.before
        });
        Grid.restoreFromLayoutSnapshot(lastAction.before);
      } else {
        // Handle square changes
        const actions = Array.isArray(lastAction) ? lastAction : [lastAction];
        const redoSnapshot = actions.map(({ square }) => Grid.snapshotSquare(square));
        State.pushRedo(redoSnapshot);
        actions.forEach(Grid.restoreSquare);
      }
      
      UI.updateUndoRedoButtons();
    },

    redo() {
      const nextAction = State.popRedo();
      if (!nextAction) return;

      // Handle layout change
      if (nextAction.type === 'layout') {
        const currentSnapshot = Grid.snapshotGridWithCoords();
        State.pushUndo({
          type: 'layout',
          before: currentSnapshot,
          after: nextAction.before
        });
        Grid.restoreFromLayoutSnapshot(nextAction.before);
      } else {
        // Handle square changes
        const undoSnapshot = nextAction.map(({ square }) => Grid.snapshotSquare(square));
        State.undoStack.push(undoSnapshot); // Direct push to avoid clearing redo
        nextAction.forEach(Grid.restoreSquare);
      }
      
      UI.updateUndoRedoButtons();
    }
  };

  // ============================================================
  // UI MODULE
  // ============================================================
  const UI = {
    updateUndoRedoButtons() {
      DOM.undoBtn.disabled = State.undoStack.length === 0;
      DOM.redoBtn.disabled = State.redoStack.length === 0;
    },

    updateLayoutLabels() {
      const isMobile = window.innerWidth < 800;
      Array.from(DOM.layoutSelect.options).forEach(option => {
        const fullLabel = option.value.replace('x', ' x ') + ' squares';
        const shortLabel = option.getAttribute('data-short');
        option.textContent = isMobile ? shortLabel : fullLabel;
      });
    },

    getBlanketDimensionsText() {
      const { cols, rows } = State.grid;
      
      // Calculate dimensions in cm
      const widthCm = (cols * Config.SQUARE_SIZE_CM) + ((cols - 1) * Config.JOIN_GAP_CM);
      const heightCm = (rows * Config.SQUARE_SIZE_CM) + ((rows - 1) * Config.JOIN_GAP_CM);
      
      // Calculate dimensions in inches (convert from cm)
      const widthIn = (widthCm / 2.54).toFixed(0);
      const heightIn = (heightCm / 2.54).toFixed(0);
      
      return `approx. ${widthCm.toFixed(0)} Ã— ${heightCm.toFixed(0)} cm Â· ${widthIn} Ã— ${heightIn} in`;
    },

    setMobileControls(isOpen) {
      DOM.controls.style.display = isOpen ? 'block' : 'none';
      DOM.closeBtn.style.display = isOpen ? 'flex' : 'none';
      DOM.header.style.display = isOpen ? 'none' : 'flex';
    },

    createPalette(container, colors, key) {
      container.innerHTML = '';
      
      if (key === 'border') {
        const transparentBtn = document.createElement('div');
        transparentBtn.className = 'color-button selected';
        transparentBtn.style.backgroundColor = 'transparent';
        transparentBtn.innerHTML = '<svg viewBox="0 0 32 32" width="32" height="32" style="position:absolute;top:0;left:0;"><line x1="4" y1="24" x2="24" y2="4" stroke="red" stroke-width="2" /></svg>';
        State.setSelection(key, 'transparent');
        transparentBtn.addEventListener('click', () => {
          container.querySelectorAll('.color-button').forEach(b => b.classList.remove('selected'));
          transparentBtn.classList.add('selected');
          State.setSelection(key, 'transparent');
          DOM.borderColorInput.classList.remove('selected');
        });
        container.appendChild(transparentBtn);
      }

      colors.forEach((color, index) => {
        const btn = document.createElement('div');
        btn.className = 'color-button' + (key !== 'border' && index === 0 ? ' selected' : '');
        btn.style.backgroundColor = color;
        if (key !== 'border' && index === 0) State.setSelection(key, color);
        btn.addEventListener('click', () => {
          container.querySelectorAll('.color-button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          State.setSelection(key, color);
          if (key === 'bg') DOM.bgColorInput.classList.remove('selected');
          if (key === 'border') DOM.borderColorInput.classList.remove('selected');
        });
        container.appendChild(btn);
      });
    },

    createIconGrid() {
      DOM.iconGrid.innerHTML = '';
      
      // "None" button
      const noneBtn = document.createElement('div');
      noneBtn.className = 'icon-button selected';
      noneBtn.textContent = 'None';
      noneBtn.addEventListener('click', () => {
        State.setIconSelection(null, '');
        this.updateIconSelection(noneBtn);
      });
      DOM.iconGrid.appendChild(noneBtn);

      // Icon buttons - using object structure with id and svg
      Config.ICON_SVGS.forEach((icon) => {
        const btn = document.createElement('div');
        btn.className = 'icon-button';
        btn.innerHTML = icon.svg;
        btn.dataset.iconId = icon.id;  // Store icon ID on button for reference
        btn.addEventListener('click', () => {
          State.setIconSelection(icon.id, icon.svg);
          this.updateIconSelection(btn);
        });
        DOM.iconGrid.appendChild(btn);
      });
    },

    updateIconSelection(selectedBtn) {
      DOM.iconGrid.querySelectorAll('.icon-button').forEach(b => b.classList.remove('selected'));
      selectedBtn.classList.add('selected');
    },

    setEditMode(mode) {
      State.editMode = mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
      
      const colorControls = document.querySelectorAll('.control-group')[1];
      const patternControls = document.querySelectorAll('.control-group')[2];
      
      if (mode === 'color') {
        colorControls.style.display = 'block';
        patternControls.style.display = 'none';
      } else if (mode === 'pattern') {
        colorControls.style.display = 'none';
        patternControls.style.display = 'block';
      } else {
        colorControls.style.display = 'block';
        patternControls.style.display = 'block';
      }
    }
  };

  // ============================================================
  // EXPORT/IMPORT DATA MODULE
  // ============================================================
  const DataIO = {
    // Generate exportable JSON data structure
    generateExportData() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const { cols, rows } = State.grid;
      
      const squaresData = Array.from(squares).map((square, index) => {
        const { row, col } = Utils.indexToCoords(index, cols);
        return {
          row,
          col,
          bgColor: square.style.backgroundColor || Config.DEFAULT_SQUARE_BG,
          borderColor: square.style.borderColor || Config.DEFAULT_SQUARE_BORDER,
          iconId: square.dataset.iconId || null
        };
      });
      
      return {
        version: 1,
        timestamp: new Date().toISOString(),
        layout: {
          cols,
          rows
        },
        squares: squaresData
      };
    },
    
    // Validate import data structure
    validateImportData(data) {
      if (!data || typeof data !== 'object') {
        return { valid: false, error: 'Invalid data format' };
      }
      
      if (!data.layout || typeof data.layout.cols !== 'number' || typeof data.layout.rows !== 'number') {
        return { valid: false, error: 'Invalid layout data' };
      }
      
      if (!Array.isArray(data.squares)) {
        return { valid: false, error: 'Invalid squares data' };
      }
      
      // Validate each square has required properties
      for (const square of data.squares) {
        if (typeof square.row !== 'number' || typeof square.col !== 'number') {
          return { valid: false, error: 'Invalid square coordinates' };
        }
      }
      
      return { valid: true };
    },
    
    // Apply imported data to the grid
    applyImportData(data) {
      const validation = this.validateImportData(data);
      if (!validation.valid) {
        throw new Error(validation.error);
      }
      
      const { cols, rows } = data.layout;
      
      // Update layout select if valid option exists
      const layoutValue = `${cols}x${rows}`;
      const layoutOption = Array.from(DOM.layoutSelect.options).find(opt => opt.value === layoutValue);
      if (layoutOption) {
        DOM.layoutSelect.value = layoutValue;
      }
      
      // Create grid without preserving content
      Grid.createGrid(cols, rows, false);
      
      // Apply square data
      const squares = DOM.gridInner.querySelectorAll('.square');
      
      data.squares.forEach(squareData => {
        const index = Utils.coordsToIndex(squareData.row, squareData.col, cols);
        const square = squares[index];
        
        if (square) {
          if (squareData.bgColor) {
            square.style.backgroundColor = squareData.bgColor;
          }
          if (squareData.borderColor) {
            square.style.borderColor = squareData.borderColor;
          }
          
          // Apply icon if iconId is provided and exists in Config
          if (squareData.iconId) {
            const icon = Utils.getIconById(squareData.iconId);
            if (icon) {
              square.innerHTML = icon.svg;
              square.dataset.iconId = icon.id;
            }
          }
        }
      });
      
      State.hasChanges = true;
    },
    
    // Download design as JSON file
    saveToFile() {
      const data = this.generateExportData();
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `blanket-design-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
    },
    
    // Load design from JSON file
    loadFromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            this.applyImportData(data);
            resolve(data);
          } catch (error) {
            reject(new Error('Failed to parse JSON file: ' + error.message));
          }
        };
        
        reader.onerror = () => {
          reject(new Error('Failed to read file'));
        };
        
        reader.readAsText(file);
      });
    }
  };

  // ============================================================
  // URL SHARE MODULE
  // ============================================================
  const URLShare = {
    // Version prefix for URL format
    VERSION: 'd1',
    
    // Character set for encoding (0-9, a-z)
    CHARS: '0123456789abcdefghijklmnopqrstuvwxyz',
    
    // Get animal ID list in order (for index mapping)
    getAnimalIds() {
      return Config.ICON_SVGS.map(icon => icon.id);
    },
    
    // Encode a value to a single character
    encodeChar(index) {
      return this.CHARS[index] || '0';
    },
    
    // Decode a character to an index
    decodeChar(char) {
      const index = this.CHARS.indexOf(char.toLowerCase());
      return index >= 0 ? index : 0;
    },
    
    // Find color index (preset or custom)
    getColorIndex(color, presets, customColors) {
      const normalized = YarnCalculator.normalizeColor(color);
      
      // Check presets first
      for (let i = 0; i < presets.length; i++) {
        if (presets[i].toLowerCase() === normalized) {
          return { index: i, isCustom: false };
        }
      }
      
      // Check custom colors
      const customIndex = customColors.indexOf(normalized);
      if (customIndex >= 0) {
        return { index: presets.length + customIndex, isCustom: true };
      }
      
      // Add as new custom color
      customColors.push(normalized);
      return { index: presets.length + customColors.length - 1, isCustom: true };
    },
    
    // Get animal index (0 = none, 1+ = animal)
    getAnimalIndex(iconId) {
      if (!iconId) return 0;
      const animals = this.getAnimalIds();
      const index = animals.indexOf(iconId);
      return index >= 0 ? index + 1 : 0;
    },
    
    // Get animal ID from index
    getAnimalId(index) {
      if (index === 0) return null;
      const animals = this.getAnimalIds();
      return animals[index - 1] || null;
    },
    
    // Encode current grid state to URL hash
    encode() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      const { cols, rows } = State.grid;
      
      const customBgColors = [];
      const customBorderColors = [];
      
      // First pass: collect custom colors
      const squareData = Array.from(squares).map(square => {
        const bg = square.style.backgroundColor || Config.DEFAULT_SQUARE_BG;
        const border = square.style.borderColor || Config.DEFAULT_SQUARE_BORDER;
        const iconId = square.dataset.iconId || null;
        
        const bgInfo = this.getColorIndex(bg, Config.PRESET_BG_COLORS, customBgColors);
        const borderInfo = this.getColorIndex(border, Config.PRESET_BORDER_COLORS, customBorderColors);
        const animalIndex = this.getAnimalIndex(iconId);
        
        return {
          bg: bgInfo.index,
          border: borderInfo.index,
          animal: animalIndex
        };
      });
      
      // Build encoded string
      let encoded = this.VERSION;
      encoded += this.encodeChar(cols);
      encoded += this.encodeChar(rows);
      
      // Encode each square (3 chars: bg, border, animal)
      squareData.forEach(sq => {
        encoded += this.encodeChar(sq.bg);
        encoded += this.encodeChar(sq.border);
        encoded += this.encodeChar(sq.animal);
      });
      
      // Append custom colors if any
      if (customBgColors.length > 0 || customBorderColors.length > 0) {
        encoded += '-';
        encoded += customBgColors.length.toString();
        encoded += customBorderColors.length.toString();
        customBgColors.forEach(c => encoded += c.replace('#', ''));
        customBorderColors.forEach(c => encoded += c.replace('#', ''));
      }
      
      return encoded;
    },
    
    // Decode URL hash to grid state
    decode(hash) {
      try {
        // Remove # if present
        hash = hash.replace(/^#/, '');
        
        // Check version
        if (!hash.startsWith(this.VERSION)) {
          console.warn('Unknown URL format version');
          return null;
        }
        
        // Parse layout
        const cols = this.decodeChar(hash[2]);
        const rows = this.decodeChar(hash[3]);
        
        if (cols < 1 || cols > 9 || rows < 1 || rows > 9) {
          console.warn('Invalid grid dimensions');
          return null;
        }
        
        // Check for custom colors section
        let customBgColors = [];
        let customBorderColors = [];
        let squareDataStr = hash.substring(4);
        
        const dashIndex = squareDataStr.indexOf('-');
        if (dashIndex > 0) {
          const colorSection = squareDataStr.substring(dashIndex + 1);
          squareDataStr = squareDataStr.substring(0, dashIndex);
          
          // Parse custom color counts
          const numCustomBg = parseInt(colorSection[0]) || 0;
          const numCustomBorder = parseInt(colorSection[1]) || 0;
          
          // Extract custom colors (6 chars each)
          let colorPos = 2;
          for (let i = 0; i < numCustomBg; i++) {
            customBgColors.push('#' + colorSection.substring(colorPos, colorPos + 6));
            colorPos += 6;
          }
          for (let i = 0; i < numCustomBorder; i++) {
            customBorderColors.push('#' + colorSection.substring(colorPos, colorPos + 6));
            colorPos += 6;
          }
        }
        
        // Parse square data
        const expectedSquares = cols * rows;
        const squares = [];
        
        for (let i = 0; i < expectedSquares; i++) {
          const pos = i * 3;
          if (pos + 2 >= squareDataStr.length) break;
          
          const bgIndex = this.decodeChar(squareDataStr[pos]);
          const borderIndex = this.decodeChar(squareDataStr[pos + 1]);
          const animalIndex = this.decodeChar(squareDataStr[pos + 2]);
          
          // Resolve colors
          let bgColor, borderColor;
          
          if (bgIndex < Config.PRESET_BG_COLORS.length) {
            bgColor = Config.PRESET_BG_COLORS[bgIndex];
          } else {
            const customIdx = bgIndex - Config.PRESET_BG_COLORS.length;
            bgColor = customBgColors[customIdx] || Config.PRESET_BG_COLORS[0];
          }
          
          if (borderIndex < Config.PRESET_BORDER_COLORS.length) {
            borderColor = Config.PRESET_BORDER_COLORS[borderIndex];
          } else {
            const customIdx = borderIndex - Config.PRESET_BORDER_COLORS.length;
            borderColor = customBorderColors[customIdx] || Config.PRESET_BORDER_COLORS[0];
          }
          
          squares.push({
            row: Math.floor(i / cols),
            col: i % cols,
            bgColor,
            borderColor,
            iconId: this.getAnimalId(animalIndex)
          });
        }
        
        return {
          version: 1,
          layout: { cols, rows },
          squares
        };
      } catch (e) {
        console.error('Failed to decode URL:', e);
        return null;
      }
    },
    
    // Apply decoded data to grid
    applyFromHash() {
      const hash = window.location.hash;
      if (!hash || hash.length < 5) return false;
      
      const data = this.decode(hash);
      if (!data) return false;
      
      try {
        DataIO.applyImportData(data);
        // Clear undo history for shared designs
        State.undoStack = [];
        State.redoStack = [];
        UI.updateUndoRedoButtons();
        return true;
      } catch (e) {
        console.error('Failed to apply shared design:', e);
        return false;
      }
    },
    
    // Generate shareable URL and show in modal
    share() {
      const encoded = this.encode();
      const url = window.location.origin + window.location.pathname + '#' + encoded;
            
      // Show modal with URL
      DOM.shareUrlInput.value = url;
      DOM.shareCopyStatus.style.display = 'none';
      DOM.shareModal.classList.add('open');
    },
    
    // Copy URL to clipboard
    async copyToClipboard() {
      const url = DOM.shareUrlInput.value;
      
      try {
        await navigator.clipboard.writeText(url);
        DOM.shareCopyStatus.style.display = 'contents';
      } catch (e) {
        // Fallback for older browsers
        DOM.shareUrlInput.select();
        document.execCommand('copy');
        DOM.shareCopyStatus.style.display = 'contents';
      }
    },
    
    // Close share modal
    closeModal() {
      DOM.shareModal.classList.remove('open');
    }
  };

  // ============================================================
  // YARN CALCULATOR MODULE
  // ============================================================
  const YarnCalculator = {
    // Check if a square is painted (not default)
    isPaintedSquare(square) {
      const bg = square.style.backgroundColor;
      const border = square.style.borderColor;
      const hasIcon = square.dataset.iconId && square.dataset.iconId !== '';
      
      // Convert default values to comparable format
      const defaultBg = this.normalizeColor(Config.DEFAULT_SQUARE_BG);
      const defaultBorder = this.normalizeColor(Config.DEFAULT_SQUARE_BORDER);
      const currentBg = this.normalizeColor(bg);
      const currentBorder = this.normalizeColor(border);
      
      // Square is painted if any property differs from default
      return currentBg !== defaultBg || currentBorder !== defaultBorder || hasIcon;
    },
    
    // Normalize color to hex format for comparison
    normalizeColor(color) {
      if (!color || color === 'transparent') return 'transparent';
      
      // If already hex, return lowercase
      if (color.startsWith('#')) return color.toLowerCase();
      
      // Convert rgb/rgba to hex
      const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (match) {
        const r = parseInt(match[1]).toString(16).padStart(2, '0');
        const g = parseInt(match[2]).toString(16).padStart(2, '0');
        const b = parseInt(match[3]).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
      }
      
      return color.toLowerCase();
    },
    
    // Convert meters to yards
    metersToYards(meters) {
      return (meters * 1.09361).toFixed(1);
    },
    
    // Format amount with both meters and yards
    formatAmount(meters) {
      return `${meters}m Â· ${this.metersToYards(meters)}yds`;
    },
    
    // Get friendly color name or hex for custom colors
    getColorName(hexColor) {
      const normalized = hexColor.toLowerCase();
      return Config.COLOR_NAMES[normalized] || hexColor;
    },
    
    // Calculate all yarn quantities
    calculate() {
      const squares = DOM.gridInner.querySelectorAll('.square');
      
      const backgrounds = {}; // { color: { amount: 0, count: 0 } }
      const borders = {};    // { color: { amount: 0, count: 0 } }
      const animals = {};    // { colorName: amount }
      
      let totalMeters = 0;
      let paintedCount = 0;
      
      squares.forEach(square => {
        if (!this.isPaintedSquare(square)) return;
        
        paintedCount++;
        const bg = this.normalizeColor(square.style.backgroundColor);
        const border = this.normalizeColor(square.style.borderColor);
        const iconId = square.dataset.iconId;
        
        // Count background color
        if (bg && bg !== 'transparent') {
          if (!backgrounds[bg]) {
            backgrounds[bg] = { amount: 0, count: 0 };
          }
          // Use 14m if square has an animal, 20m if no animal
          const bgYarn = iconId ? Config.YARN_PER_SQUARE.background : Config.YARN_PER_SQUARE.backgroundNoAnimal;
          backgrounds[bg].amount += bgYarn;
          backgrounds[bg].count += 1;
          totalMeters += bgYarn;
        }
        
        // Count border color
        if (border && border !== 'transparent') {
          if (!borders[border]) {
            borders[border] = { amount: 0, count: 0 };
          }
          borders[border].amount += Config.YARN_PER_SQUARE.border;
          borders[border].count += 1;
          totalMeters += Config.YARN_PER_SQUARE.border;
        }
        
        // Count animal yarn
        if (iconId && Config.ANIMAL_YARN[iconId]) {
          const animalYarn = Config.ANIMAL_YARN[iconId];
          for (const [colorName, meters] of Object.entries(animalYarn)) {
            if (!animals[colorName]) {
              animals[colorName] = 0;
            }
            animals[colorName] += meters;
            totalMeters += meters;
          }
        }
      });
      
      return { backgrounds, borders, animals, totalMeters, paintedCount };
    },
    
    // Render the modal content
    renderModal() {
      const { backgrounds, borders, animals, totalMeters, paintedCount } = this.calculate();
      
      // Check if there's any data
      const hasBackgrounds = Object.keys(backgrounds).length > 0;
      const hasBorders = Object.keys(borders).length > 0;
      const hasAnimals = Object.keys(animals).length > 0;
      
      if (!hasBackgrounds && !hasBorders && !hasAnimals) {
        DOM.yarnModalBody.innerHTML = `
          <div class="yarn-empty">
            <p>Nothing to calculate yet.</p>
            <p>Start designing your blanket to see yarn quantities!</p>
          </div>
        `;
        if (DOM.yarnTotal) {
          DOM.yarnTotal.textContent = 'Total: 0m Â· 0yds';
        }
        return;
      }
      
      let html = '';
      
      // Disclaimer
      html += `
        <div class="yarn-disclaimer">
          ðŸ’¡ These estimates are based on a tight-to-average crochet tension. Everyone crochets a little differently, so your final size and yarn usage may vary.
        </div>
      `;

      // Estimated size section
      html += `
        <div class="yarn-section">
          <div class="yarn-section-title">Estimated blanket size</div>
          <div class="yarn-amount">${UI.getBlanketDimensionsText()}</div>
        </div>
      `;
      
      // Backgrounds section
      const bgEntries = Object.entries(backgrounds);
      if (bgEntries.length > 0) {
        html += `
          <div class="yarn-section">
            <div class="yarn-section-title">Base squares</div>
        `;
        for (const [color, data] of bgEntries) {
          const colorName = this.getColorName(color);
          html += `
            <div class="yarn-item">
              <div class="yarn-color-swatch" style="background-color: ${color}"></div>
              <span class="yarn-color-name">${colorName}</span>
              <span class="yarn-amount">${this.formatAmount(data.amount)}</span>
              <span class="yarn-count">(${data.count} ${data.count === 1 ? 'square' : 'squares'})</span>
            </div>
          `;
        }
        html += '</div>';
      }
      
      // Borders section
      const borderEntries = Object.entries(borders);
      if (borderEntries.length > 0) {
        html += `
          <div class="yarn-section">
            <div class="yarn-section-title">Borders</div>
        `;
        for (const [color, data] of borderEntries) {
          const colorName = this.getColorName(color);
          html += `
            <div class="yarn-item">
              <div class="yarn-color-swatch" style="background-color: ${color}"></div>
              <span class="yarn-color-name">${colorName}</span>
              <span class="yarn-amount">${this.formatAmount(data.amount)}</span>
              <span class="yarn-count">(${data.count} ${data.count === 1 ? 'square' : 'squares'})</span>
            </div>
          `;
        }
        html += '</div>';
      }
      
      // Animals section
      const animalEntries = Object.entries(animals);
      if (animalEntries.length > 0) {
        // Sort by amount descending
        animalEntries.sort((a, b) => b[1] - a[1]);
        
        html += `
          <div class="yarn-section">
            <div class="yarn-section-title">Animals</div>
        `;
        for (const [colorName, amount] of animalEntries) {
          html += `
            <div class="yarn-item">
              <span class="yarn-color-name">${colorName}</span>
              <span class="yarn-amount">${this.formatAmount(amount)}</span>
            </div>
          `;
        }
        html += '</div>';
      }
      
      DOM.yarnModalBody.innerHTML = html;
      if (DOM.yarnTotal) {
        DOM.yarnTotal.textContent = `Total: ${this.formatAmount(totalMeters)}`;
      }
    },
    
    // Open modal
    openModal() {
      this.renderModal();
      DOM.yarnModal.classList.add('open');
    },
    
    // Close modal
    closeModal() {
      DOM.yarnModal.classList.remove('open');
    }
  };

  // ============================================================
  // IMAGE EXPORT MODULE
  // ============================================================
  const Export = {
    async exportAsImage() {
      try {
        // Show loading state
        DOM.exportBtn.disabled = true;
        
        // Lazy load html2canvas
        const html2canvas = await Utils.loadHtml2Canvas();
        
        const gridInner = DOM.gridInner;
        const clone = gridInner.cloneNode(true);

        const wrapper = document.createElement('div');
        wrapper.style.position = 'absolute';
        wrapper.style.top = '-9999px';
        wrapper.style.left = '-9999px';
        wrapper.style.background = 'white';
        wrapper.style.padding = '20px';
        wrapper.style.display = 'inline-block';
        wrapper.appendChild(clone);

        document.body.appendChild(wrapper);

        const canvas = await html2canvas(wrapper, { scale: 2 });
        document.body.removeChild(wrapper);
        
        const link = document.createElement('a');
        link.download = 'crochet_layout.png';
        link.href = canvas.toDataURL();
        link.click();
      } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed. Please try again.');
      } finally {
        DOM.exportBtn.disabled = false;
      }
    }
  };

  // ============================================================
  // EVENT HANDLERS MODULE
  // ============================================================
  const Events = {
    init() {
      // Grid event delegation - single listener for all squares
      this.setupGridEventDelegation();
      
      // Layout change with position preservation
      DOM.layoutSelect.addEventListener('change', () => {
        const { cols, rows } = Utils.parseLayout(DOM.layoutSelect.value);
        Grid.createGrid(cols, rows, true); // preserve content
        UI.updateLayoutLabels();
      });

      // Mode toggle
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => UI.setEditMode(btn.dataset.mode));
      });

      // Color inputs
      DOM.bgColorInput.addEventListener('input', () => {
        State.setSelection('bg', DOM.bgColorInput.value);
        this.syncPaletteSelection(DOM.bgPalette, DOM.bgColorInput);
      });

      DOM.borderColorInput.addEventListener('input', () => {
        State.setSelection('border', DOM.borderColorInput.value);
        this.syncPaletteSelection(DOM.borderPalette, DOM.borderColorInput);
      });

      // Action buttons
      DOM.undoBtn.addEventListener('click', History.undo);
      DOM.redoBtn.addEventListener('click', History.redo);
      DOM.saveJsonBtn.addEventListener('click', () => {
        DataIO.saveToFile();
        DOM.dropdownMenu.classList.remove('open');
      });
      DOM.loadJsonBtn.addEventListener('click', () => {
        DOM.loadJsonInput.click();
        DOM.dropdownMenu.classList.remove('open');
      });
      DOM.loadJsonInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            await DataIO.loadFromFile(file);
            console.log('Design loaded successfully');
          } catch (error) {
            alert('Failed to load design: ' + error.message);
            console.error(error);
          }
          // Reset input so same file can be loaded again
          e.target.value = '';
        }
      });
      DOM.clearBtn.addEventListener('click', () => Grid.clearAll());
      DOM.applyAllBtn.addEventListener('click', () => Grid.applyToAll());
      DOM.randomizeBtn.addEventListener('click', () => Grid.randomize());
      DOM.exportBtn.addEventListener('click', () => Export.exportAsImage());

      // Dropdown menu toggle
      DOM.menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        DOM.dropdownMenu.classList.toggle('open');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!DOM.dropdownMenu.contains(e.target) && e.target !== DOM.menuBtn) {
          DOM.dropdownMenu.classList.remove('open');
        }
      });

      // Yarn quantities modal
      DOM.yarnQuantitiesBtn.addEventListener('click', () => {
        DOM.dropdownMenu.classList.remove('open');
        YarnCalculator.openModal();
      });
      
      // Share link
      DOM.shareLinkBtn.addEventListener('click', () => {
        DOM.dropdownMenu.classList.remove('open');
        URLShare.share();
      });
      
      // Share modal controls
      DOM.copyShareUrlBtn.addEventListener('click', () => {
        URLShare.copyToClipboard();
      });
      
      DOM.shareModalClose.addEventListener('click', () => {
        URLShare.closeModal();
      });
      
      DOM.shareModal.addEventListener('click', (e) => {
        if (e.target === DOM.shareModal) {
          URLShare.closeModal();
        }
      });
      
      DOM.yarnModalClose.addEventListener('click', () => {
        YarnCalculator.closeModal();
      });
      
      // Close modal when clicking overlay
      DOM.yarnModal.addEventListener('click', (e) => {
        if (e.target === DOM.yarnModal) {
          YarnCalculator.closeModal();
        }
      });

      // Mobile controls
      DOM.toggleBtn.addEventListener('click', () => UI.setMobileControls(true));
      DOM.closeBtn.addEventListener('click', () => {
        DOM.hint.style.display = 'none';
        UI.setMobileControls(false);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
          e.preventDefault();
          History.undo();
        }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))) {
          e.preventDefault();
          History.redo();
        }
      });

      // Window resize with debounce
      window.addEventListener('resize', Utils.debounce(() => {
        if (window.innerWidth > 800) {
          DOM.controls.style.display = 'flex';
          DOM.closeBtn.style.display = 'none';
          DOM.header.style.display = 'flex';
        } else {
          DOM.controls.style.display = 'none';
          DOM.closeBtn.style.display = 'flex';
          DOM.header.style.display = 'flex';
        }
        UI.updateLayoutLabels();
      }, Config.RESIZE_DEBOUNCE_MS));

      // Global mouse/touch end handlers
      document.addEventListener('mouseup', () => this.endBulkPaint());
      document.addEventListener('touchend', () => this.endBulkPaint());
    },

    // Event delegation for grid
    setupGridEventDelegation() {
      const gridInner = DOM.gridInner;

      // Mouse events
      gridInner.addEventListener('mousedown', (e) => {
        const square = e.target.closest('.square');
        if (!square) return;
        
        State.isPainting = true;
        State.currentBulkAction = [Grid.snapshotSquare(square)];
        Grid.applyToSquare(square, false);
      });

      gridInner.addEventListener('mouseenter', (e) => {
        if (!State.isPainting) return;
        const square = e.target.closest('.square');
        if (!square) return;
        
        // Check if already in current bulk action
        if (!State.currentBulkAction.find(s => s.square === square)) {
          State.currentBulkAction.push(Grid.snapshotSquare(square));
        }
        Grid.applyToSquare(square, false);
      }, true); // Use capture for mouseenter delegation

      // Touch events
      gridInner.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        const square = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.square');
        if (!square) return;
        
        e.preventDefault();
        State.isPainting = true;
        State.currentBulkAction = [Grid.snapshotSquare(square)];
        Grid.applyToSquare(square, false);
      }, { passive: false });

      gridInner.addEventListener('touchmove', (e) => {
        if (!State.isPainting) return;
        
        const touch = e.touches[0];
        const elem = document.elementFromPoint(touch.clientX, touch.clientY);
        const square = elem?.closest('.square');
        
        if (square && !State.currentBulkAction.some(s => s.square === square)) {
          State.currentBulkAction.push(Grid.snapshotSquare(square));
          Grid.applyToSquare(square, false);
        }
      }, { passive: false });
    },

    endBulkPaint() {
      if (State.isPainting && State.currentBulkAction.length > 0) {
        State.pushUndo([...State.currentBulkAction]);
        UI.updateUndoRedoButtons();
      }
      State.isPainting = false;
      State.currentBulkAction = [];
    },

    syncPaletteSelection(palette, input) {
      let matched = false;
      palette.querySelectorAll('.color-button').forEach(b => {
        if (b.style.backgroundColor === input.value) {
          b.classList.add('selected');
          matched = true;
        } else {
          b.classList.remove('selected');
        }
      });
      input.classList.toggle('selected', !matched);
    }
  };

  // ============================================================
  // INITIALIZATION
  // ============================================================
  function init() {
    // Setup palettes
    UI.createPalette(DOM.bgPalette, Config.PRESET_BG_COLORS, 'bg');
    UI.createPalette(DOM.borderPalette, Config.PRESET_BORDER_COLORS, 'border');
    UI.createIconGrid();
    
    // Check for shared design in URL hash
    const hasSharedDesign = window.location.hash && window.location.hash.length > 4;
    
    if (hasSharedDesign) {
      // Try to load shared design
      const loaded = URLShare.applyFromHash();
      if (!loaded) {
        // Fallback to default grid if URL is invalid
        const { cols, rows } = Utils.parseLayout(DOM.layoutSelect.value);
        Grid.createGrid(cols, rows, false);
      }
    } else {
      // Create initial grid (no content to preserve on first load)
      const { cols, rows } = Utils.parseLayout(DOM.layoutSelect.value);
      Grid.createGrid(cols, rows, false);
    }
    
    // Setup event handlers
    Events.init();
    
    // Initial UI state
    UI.updateUndoRedoButtons();
    UI.updateLayoutLabels();
  }

  // Start the app
  init();
})();
</script>

</body>
</html>
