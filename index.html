<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="mobile-web-app-capable" content="yes">
  <title>Animal Blanket Designer</title>
  <style>
  html, body {
    background-image: url(https://morganepeng.com/img/dot_grid2.png);
    background-repeat: repeat;
    background-color: #fdfdfd;
    margin: 0;
    padding: 0;
    height: 100%;
    min-height: -webkit-fill-available;
    overscroll-behavior-y: contain;
    font-family: 'Inter', sans-serif;
    touch-action: manipulation;
  }
  body {
    display: flex;
    height: 100vh;
  }
  header {
    position: absolute;
    top: 0;
    left: 0;
    right: 334px;
    z-index: 100;
    height: 60px;
    padding: 0.5em 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 {
    margin: 0 1rem 0 0.1rem;
    font-size: 1.2rem;
  }
  h2 {
    font-weight: bold;
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }
  h3 {
    font-weight: normal;
    font-size: 1rem;
    margin: 0 0 0.5rem;
  }
  select {
    padding-right: 0.4rem;
  }
  a:link {
    color: #858585;
  }
  a:hover {
    color: #666666;
  }
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  #grid {
    padding-top: 60px;
    flex: 1;
    display: grid;
    padding: 1rem;
    gap: 2px;
    justify-content: center;
    align-content: center;
    overflow-y: auto;
  }
  #gridInner {
    display: grid;
    gap: 2px;
    background: white;
    padding: 0;
    user-select: none;
  }
  .square {
    width: 100px;
    height: 100px;
    background-color: #eeeeee;
    border: 8px solid transparent;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
  }
  .square img {
    max-width: 90%;
    max-height: 90%;
    aspect-ratio: 1 / 1;
    pointer-events: none;
  }

  #controls {
    width: 300px;
    padding: 1rem;
    border-left: 1px solid #ddd;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  #closeBtn {
    display:none;
    position: fixed;
    top: 1rem;
    right: 1rem;
  } 
  .control-group {
    margin-bottom: 1.4rem;
  }
  .control-sub-group {
    background-color: #eeeeee;
    padding: 10px;
    border-radius: 0.5rem;
  }
  .control-sub-group:not(:last-child) {
    margin-bottom: 0.5rem;
  }
  .control-sub-group-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .control-footer {
    position: sticky;
    bottom: 0;
    padding: 0 0 0.5rem 0;
    z-index: 1;
  }
  .color-palette {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .color-button {
    width: 32px;
    height: 32px;
    border: 2px solid #ccc;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    box-sizing: border-box;
  }
  .color-button.selected {
    border-color: #000;
  }
  .badge {
    font-size: 0.8rem;
    background: #e0e7ff;
    color: #1e3a8a; padding: 2px 6px;
    border-radius: 6px;
    vertical-align: middle;
  }
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .icon-button {
    height: 56px;
    border: 2px solid transparent;
    background: #eeeeee;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
  }
  .icon-button.selected {
    border-color: black;
  }
  .icon-button img {
    width: 52px;
    height: 52px;
  }
  input[type="color"] {
    width: 32px;
    height: 32px;
    box-sizing: border-box;
  }
  input[type="color"].selected,
  input[type="color"]:focus {
    outline: none;
  }

  select, button {
    font-family: inherit;
    font-size: 1rem;
    padding: 0.5em;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  select {
    border: 1px solid #ccc;
    background: white;
    color: #333;
    cursor: pointer;
    padding-right: 2em;
    background-position: right 0.75em center;
    background-repeat: no-repeat;
    background-size: 0.65em auto;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpolyline points='4,8 10,14 16,8' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75em center;
    background-size: 0.65em auto;
  }
  select:hover {
    background: #f9f9f9;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpolyline points='4,8 10,14 16,8' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75em center;
    background-size: 0.65em auto;
  }
  button {
    border: 1px solid #ccc;
    background: #ffffff;
    color: #333;
    cursor: pointer;
    min-width: 42px;
  }
  button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }
  button:hover {
    background: #f9f9f9;
  }
  button svg {
    pointer-events: none;
  }
  button.palette {
    display: none;
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }
  .button-group {
    display: flex; align-items: center; gap: 0.5rem; align-self: center;
  }
  .button-group-space-between {
    display: flex; justify-content: space-between; gap: 0.5rem;
  }
  .mode-toggle {
    display: flex;
    width: 100%;
    justify-content: space-between;
    border-radius: 0.5rem;
    background-color: #eeeeee;
    padding: 4px;
    box-sizing: border-box;
  }
  .mode-btn {
    flex: 1;
    padding: 0.5em 1em;
    font-size: 1rem;
    font-weight: 500;
    border: 1px solid transparent;
    background: none;
    color: #374151;
    border-radius: 0.375rem;
    cursor: pointer;
    box-shadow: 0 0px 0px rgba(0, 0, 0, 0);
  }
  .mode-btn:hover {
    background-color: #f0f0f0;
  }
  .mode-btn.selected {
    background-color: #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .flex-grow {
  flex: 1;
  }
  .muted {
    font-size: 0.9rem;
    color: #858585;
  }
  
  #hint {
    display: none;
  }

  @media (max-height: 780px) {
    .icon-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 1260px) {
    .hide-ms {
      display: none;
    }
    #controls {
      display: block; 
      width: 300px;
      padding: 1rem;
      border-left: 1px solid #ddd;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .square {
      width: 100%;
      aspect-ratio: 1 / 1;
      height: auto !important;
    }
  }

  @media (max-width: 800px) {
    .hide-xs {
      display: none;
    }
    #hint {
      display: block;
    }
    header {
      right: 0;
      z-index: 1002;
    }
    button.palette {
      display: block;
    }
    #controls {
      padding: 2.5rem 1rem 1rem 1rem;
      display: none; 
      position: fixed;
      top: 0px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1001;
      box-sizing: border-box; 
      border-top: 1px solid #ddd;
      border-radius: 0.5rem 0.5rem 0;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    }
    .icon-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
</head>

<body>
<header id="header">
  <div class="button-group">
    <div class="hide-ms">
      <h1>Animal Blanket Designer <span class="badge">beta</span></h1>
      <span class="muted">Edit then add on the grid. <a href="https://morganeyarn.com" target="_blank">Get patterns ↗</a></span>
    </div>
    <select id="layout">
      <option value="3x4" data-short="3 x 4">3 x 4 squares</option>
      <option value="3x5" data-short="3 x 5">3 x 5 squares</option>
      <option value="4x4" data-short="4 x 4">4 x 4 squares</option>
      <option value="4x6" data-short="4 x 6">4 x 6 squares</option>
      <option value="5x5" data-short="5 x 5">5 x 5 squares</option>
      <option value="5x6" data-short="5 x 6" selected>5 x 6 squares</option>
      <option value="6x6" data-short="6 x 6">6 x 6 squares</option>
      <option value="6x8" data-short="6 x 8">6 x 8 squares</option>
    </select>
  </div>
  <div class="button-group">
    <button id="undoBtn" aria-label="Undo" disabled><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M280-200v-80h284q63 0 109.5-40T720-420q0-60-46.5-100T564-560H312l104 104-56 56-200-200 200-200 56 56-104 104h252q97 0 166.5 63T800-420q0 94-69.5 157T564-200H280Z"/></svg></button>
    <button id="redoBtn" aria-label="Redo" disabled><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M396-200q-97 0-166.5-63T160-420q0-94 69.5-157T396-640h252L544-744l56-56 200 200-200 200-56-56 104-104H396q-63 0-109.5 40T240-420q0 60 46.5 100T396-280h284v80H396Z"/></svg></button>
    <button id="clearBtn" aria-label="Clear" disabled class="hide-ms"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button>
    <a href="https://morganeyarn.com/contact" target="_blank"><button aria-label="Contact"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m480-80-10-120h-10q-142 0-241-99t-99-241q0-142 99-241t241-99q71 0 132.5 26.5t108 73q46.5 46.5 73 108T800-540q0 75-24.5 144t-67 128q-42.5 59-101 107T480-80Zm80-146q71-60 115.5-140.5T720-540q0-109-75.5-184.5T460-800q-109 0-184.5 75.5T200-540q0 109 75.5 184.5T460-280h100v54Zm-101-95q17 0 29-12t12-29q0-17-12-29t-29-12q-17 0-29 12t-12 29q0 17 12 29t29 12Zm-29-127h60q0-30 6-42t38-44q18-18 30-39t12-45q0-51-34.5-76.5T460-720q-44 0-74 24.5T344-636l56 22q5-17 19-33.5t41-16.5q27 0 40.5 15t13.5 33q0 17-10 30.5T480-558q-35 30-42.5 47.5T430-448Zm30-65Z"/></svg></button></a>
    <button id="exportBtn" aria-label="Download"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg></button>
    <button aria-label="Configure" class="palette" id="toggleControlsBtn"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-220 40q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120-160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm200 0q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120 160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T488-800q-136 0-232 93t-96 227q0 133 93.5 226.5T480-160Z"/></svg></button>
  </div>
</header>
<div id="hint" style="position: fixed; top: 64px; right: 28px;"><svg xmlns="http://www.w3.org/2000/svg" height="90px" viewBox="0 0 100 70">
  <text style="fill: rgb(51, 51, 51); font-family: Caveat; font-size: 20px; white-space: pre; text-anchor: middle;" transform="matrix(1, 0, 0, 1, 40.798481, -65.23407)"><tspan x="0" y="107.918">try the <tspan x="0" dy="1em">​</tspan>config </tspan><tspan>panel</tspan></text>
  <defs><style bx:fonts="Caveat">@import url(https://fonts.googleapis.com/css2?family=Caveat%3Aital%2Cwght%400%2C400..700&amp;display=swap);</style></defs><path style="fill: none; stroke: black; stroke-width: 2px; stroke-linecap: round;" d="M 74.294 39.624 C 78.804 41.127 83.8 34.712 86.108 31.827 C 93.746 22.279 96.032 13.246 96.032 1.347"/><path style="fill: none; stroke: black; stroke-width: 2px; stroke-linecap: round;" d="M 92.961 9.381 C 92.961 7.574 94.877 2.739 96.032 1.584 C 96.405 1.211 97.556 2.569 97.686 2.765 C 98.561 4.077 99.104 5.275 99.104 7.254"/></svg>
</div>
<main>
  <div id="grid"><div id="gridInner"></div></div>
</main>
<aside id="controls">
  <button id="closeBtn"><svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button>
  <div class="control-group">
  <h2>Edit mode</h2>
  <div class="mode-toggle">
    <button type="button" class="mode-btn selected" data-mode="all">All</button>
    <button type="button" class="mode-btn" data-mode="color">Color</button>
    <button type="button" class="mode-btn" data-mode="pattern">Animal</button>
  </div>
  </div>
  <div class="control-group">
    <h2>Square colors</h2>
    <div class="control-sub-group">
      <h3>Background</h3>
      <div class="control-sub-group-item">
        <div class="color-palette" id="bgPalette"></div>
        or <input type="color" id="bgColor" value="#c7aae4"/>
      </div>
    </div>
    <div class="control-sub-group">
      <h3>Border</h3>
      <div class="control-sub-group-item">
        <div class="color-palette" id="borderPalette"></div>
        or <input type="color" id="borderColor" value="#856d9c"/>
      </div>
    </div>
  </div>
  <div class="control-group">
    <h2>Square animals</h2>
    <div class="icon-grid" id="iconGrid"></div>
  </div>
  <div class="control-footer button-group-space-between hide-xs">
    <button id="applyAllBtn" class="flex-grow">Apply to all</button>
    <button id="randomizeBtn" class="flex-grow">Randomize</button>
  </div>
</aside>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
(() => {
  const closeBtn = document.getElementById('closeBtn');
  const hint = document.getElementById('hint');
  const toggleBtn = document.getElementById('toggleControlsBtn');
  const header = document.getElementById('header');
  const grid = document.getElementById('grid');
  const layoutSelect = document.getElementById('layout');
  const bgPalette = document.getElementById('bgPalette');
  const borderPalette = document.getElementById('borderPalette');
  const bgColorInput = document.getElementById('bgColor');
  const borderColorInput = document.getElementById('borderColor');
  const iconGrid = document.getElementById('iconGrid');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const undoStack = [];
  const redoStack = [];

  const presetBGColors = ['#f0ead5', '#849587', '#c9a68d', '#ebad93', '#93c3eb'];
  const presetBorderColors = ['#495f4a', '#e1c8a7', '#cd896d', '#506584'];
  const iconPaths = Array.from({ length: 19 }, (_, i) => `icons/icon${i + 1}.svg`);

  const iconSvgs = [
      '<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 1164 1164"><path d="M 151.032 255.262 C 149.802 255.556 145.278 256.609 140.975 257.603 C 104.678 266.006 67.631 293.202 60.108 316.969 C 48.115 354.86 53.824 392.252 75.4 417.127 C 79.508 421.865 85.773 429.333 89.326 433.726 C 109.935 459.213 125.255 471.242 148.885 480.502 C 168.785 488.299 174.423 489.946 186.79 491.576 C 192.32 492.305 202.554 493.887 209.529 495.092 C 216.504 496.298 224.613 497.285 227.547 497.285 C 240.195 497.285 240.062 497.051 235.798 511.491 C 229.887 531.516 225.632 548.929 224.362 558.294 C 223.722 563.013 222.372 570.498 221.364 574.927 C 219.974 581.028 207.297 613.293 207.12 643.367 C 206.616 728.792 207.428 743.385 215.389 775.067 C 226.508 819.314 234.36 848.641 257.449 886.81 C 287.6 936.656 329.295 963.964 362.548 985.335 C 408.084 1014.6 421.394 1024.28 486.31 1034.27 C 543.055 1043.02 585.302 1041.21 611.975 1039.19 C 647.988 1036.48 666.832 1032.96 707.884 1024.07 C 717.993 1021.89 784.928 1005.05 829.592 964.443 C 831.599 962.618 885.99 928.396 925.495 862.038 C 933.908 847.909 943.71 827.254 953.917 805.548 C 964.491 783.062 965.558 776.561 977.431 741.289 C 988.477 708.468 986.826 701.352 988.54 677.298 C 989.26 667.176 992.745 628.63 980.182 570.325 C 967.618 512.019 966.628 521.211 965.737 517.415 C 963.807 509.211 963.379 509.71 974.584 507.151 C 999.005 501.578 1028.64 488.508 1045.71 475.784 C 1064.15 462.018 1068.74 458.352 1074.96 452.426 C 1094.07 434.184 1112.68 389.826 1112.55 362.895 C 1112.47 346.311 1107.22 328.37 1099.81 319.292 C 1098.38 317.549 1095.36 312.5 1093.08 308.072 C 1064.48 252.521 989.017 247.343 918.158 296.068 C 899.514 308.887 889.581 317.813 881.324 329.162 C 872.501 341.286 820.363 301.314 720.366 286.793 C 694.817 283.082 651.964 269.292 591.396 272.538 C 562.536 274.082 555.147 275.656 536.127 278.804 C 509.942 283.14 440.589 302.542 441.727 302.542 C 446.691 302.542 389.959 314.697 335.327 330.505 C 325.424 333.37 289.036 349.439 290.515 345.521 C 296.565 329.472 253.214 279.565 219.613 263.895 C 203.865 256.551 165.796 251.759 151.032 255.262" stroke="none" fill="#ab662e" fill-rule="evenodd"></path><path d="M 776.632 164.797 C 756.575 173.65 713.816 283.143 723.153 301.733 C 726.434 308.264 742.646 315.294 758.994 317.27 C 766.327 318.158 775.083 319.494 778.451 320.243 C 795.85 324.109 815.749 317.3 818.67 306.477 C 819.945 301.762 815.535 259.647 811.37 236.759 C 809.874 228.533 807.855 216.629 806.885 210.303 C 802.373 180.892 799.442 171.888 792.788 167.014 C 789.026 164.255 780.505 163.088 776.632 164.797 M 387.805 172.811 C 375.879 180.297 374.62 188.163 374.621 255.16 C 374.623 320.568 374.786 321.3 389.432 321.3 C 391.22 321.3 393.337 322.11 394.136 323.1 C 398.712 328.776 411.596 329.9 416.712 325.069 C 418.091 323.767 421.982 322.112 425.363 321.394 C 451.967 315.734 469.135 298.906 462.099 285.377 C 461.41 284.049 460.891 280.626 460.946 277.771 C 461.065 271.692 456.955 258.702 451.061 246.533 C 448.764 241.788 444.217 231.437 440.96 223.53 C 423.342 180.769 404.206 162.515 387.805 172.811 M 558.689 680.164 C 431.724 691.183 354.745 766.257 391.794 842.929 C 447.673 958.571 711.488 969.54 783.682 859.225 C 843.542 767.756 716.297 666.487 558.689 680.164 M 655.561 786.858 C 642.73 793.468 641.759 833.923 654.254 841.492 C 668.607 850.189 678.455 838.605 678.459 813.025 C 678.463 788.805 670.174 779.333 655.561 786.858 M 503.025 787.608 C 487.77 794.538 486.655 844.779 501.585 852.492 C 516.09 859.985 521.958 851.671 523.589 821.331 C 525.199 791.402 518.576 780.541 503.025 787.608" stroke="none" fill="#f0e4c9" fill-rule="evenodd"></path><path d="M 649.41 266.168 C 644.493 266.731 631.167 267.09 619.798 266.967 C 597.716 266.723 592.205 272.218 591.305 272.573 C 584.721 275.174 583.043 296.894 587.322 324.175 C 588.512 331.767 590.069 345.484 590.781 354.656 C 591.987 370.216 594.531 389.227 601.244 432.873 C 605.726 461.999 606.343 473.464 605.604 513.675 C 604.111 595.079 613.505 606.704 681.255 607.288 C 696.314 607.417 712.233 607.879 716.633 608.315 C 733.431 609.977 744.343 601.746 748.703 584.128 C 753.33 565.426 753.87 482.151 749.63 440.348 C 748.408 428.288 747.715 410.647 747.619 389.164 C 747.422 344.179 744.193 351.864 737.522 316.751 C 735.735 307.353 738.322 305.997 726.291 287.376 C 716.293 271.906 688.303 261.719 649.41 266.168 M 491.851 267.79 C 474.913 272.357 462.238 276.935 462.238 278.489 C 462.238 279.408 433.054 295.521 423.542 323.601 C 423.168 324.707 421.962 325.739 421.824 331.938 C 421.463 348.142 422.207 357.84 426.043 386.863 C 428.965 408.965 430.174 423.282 430.955 444.951 C 431.525 460.767 432.288 477.07 432.653 481.181 C 433.018 485.295 433.758 505.482 434.3 526.041 C 435.518 572.311 437.655 584.404 446.167 593.21 C 465.875 613.601 565.194 596.144 577.423 570.137 C 580.406 563.797 579.919 452.754 576.774 421.451 C 575.911 412.866 574.864 390.572 574.451 371.909 C 573.344 322.082 573.81 308.484 553.676 287.537 C 548.292 281.939 539.341 276.915 539.341 276.37 C 539.341 269.397 507.342 263.615 491.851 267.79 M 779.112 304.787 C 754.794 297.837 747.775 326.736 754.175 395.848 C 755.247 407.431 756.124 421.508 756.124 427.131 C 756.124 432.753 757.63 448.167 759.469 461.382 C 761.308 474.599 763.321 493.907 763.94 504.288 C 764.559 514.671 765.56 527.306 766.165 532.367 C 766.769 537.427 767.589 552.957 767.987 566.874 C 769.066 604.699 772.908 610.368 800.068 614.213 C 852.081 621.574 888.591 611.421 896.173 587.489 C 900.749 573.045 900.463 535.794 894.832 413.893 C 893.418 383.28 887.61 360.974 877.535 347.458 C 875.292 344.446 854.134 317.686 854.134 317.686 M 330.248 321.863 C 293.856 329.387 288.213 335.245 288.689 365.009 C 288.804 372.284 288.16 388.551 287.26 401.154 C 284.642 437.715 284.989 525.168 287.815 540.995 C 289 547.637 290.538 559.541 291.233 567.447 C 292.796 585.22 294.318 589.032 302.745 596.282 C 309.958 602.483 309.621 602.366 320.883 602.528 C 325.185 602.589 334.99 603.069 342.673 603.593 C 377.172 605.948 406.366 598.916 406.366 588.25 C 406.366 587.549 409.328 584.005 412.949 580.375 C 422.908 570.392 424.231 558.847 421.022 509.939 C 419.818 491.587 419.674 473.987 420.372 430.573 C 421.531 358.402 421.532 358.627 419.815 351.205 C 416.913 338.654 411.94 331.178 405.808 330.142 C 401.539 329.422 398.7 328.304 395.192 325.962 C 393.654 324.938 383.842 322.381 381.555 321.182 C 375.214 317.851 347.902 318.212 330.248 321.863" stroke="none" fill="#9b5925" fill-rule="evenodd"></path><path d="M 393.609 615.885 C 360.957 626.613 346.117 673.493 368.867 694.049 C 402.908 724.816 447.65 702.832 447.662 655.335 C 447.67 626.876 420.503 607.048 393.609 615.885 M 744.815 620.902 C 717.282 634.139 711.632 670.659 733.123 696.499 C 757.913 726.313 809.92 703.371 810.047 662.563 C 810.145 631.158 772.926 607.389 744.815 620.902" stroke="none" fill="#191920" fill-rule="evenodd"></path></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><ellipse style="fill: rgb(216, 216, 216); stroke: rgb(0, 0, 0);" cx="29.055" cy="25.224" rx="13.091" ry="10.536" transform="matrix(1, 0, 0, 1, 7.105427357601002e-15, 0)"/></svg>',
    ];

  const currentSelection = {
    bg: '#ffffff',
    border: 'transparent',
    icon: ''
  };

  let editMode = 'all';
  let mobileMode = false;

  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      editMode = btn.dataset.mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      const colorControls = document.querySelectorAll('.control-group')[1];
      const patternControls = document.querySelectorAll('.control-group')[2];
      if (editMode === 'color') {
        colorControls.style.display = 'block';
        patternControls.style.display = 'none';
      } else if (editMode === 'pattern') {
        colorControls.style.display = 'none';
        patternControls.style.display = 'block';
      } else {
        colorControls.style.display = 'block';
        patternControls.style.display = 'block';
      }
    });
  });

  function createPalette(container, colors, key) {
    container.innerHTML = '';
    if (key === 'border') {
      const transparentBtn = document.createElement('div');
      transparentBtn.className = 'color-button selected';
      transparentBtn.style.backgroundColor = 'transparent';
      transparentBtn.innerHTML = '<svg viewBox="0 0 32 32" width="32" height="32" style="position:absolute;top:0;left:0;"><line x1="4" y1="24" x2="24" y2="4" stroke="red" stroke-width="2" /></svg>';
      currentSelection[key] = 'transparent';
      transparentBtn.addEventListener('click', () => {
        container.querySelectorAll('.color-button').forEach(b => b.classList.remove('selected'));
        transparentBtn.classList.add('selected');
        currentSelection[key] = 'transparent';
        borderColorInput.classList.remove('selected');
      });
      container.appendChild(transparentBtn);
    }

    colors.forEach((color, index) => {
      const btn = document.createElement('div');
      btn.className = 'color-button' + (key !== 'border' && index === 0 ? ' selected' : '');
      btn.style.backgroundColor = color;
      if (key !== 'border' && index === 0) currentSelection[key] = color;
      btn.addEventListener('click', () => {
        container.querySelectorAll('.color-button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentSelection[key] = color;
        if (key === 'bg') bgColorInput.classList.remove('selected');
        if (key === 'border') borderColorInput.classList.remove('selected');
      });
      container.appendChild(btn);
    });
  }

  function createIconGrid() {
    iconGrid.innerHTML = '';
    // “None” button
    const noneBtn = document.createElement('div');
    noneBtn.className = 'icon-button selected';
    noneBtn.textContent = 'None';
    noneBtn.addEventListener('click', () => {
      currentSelection.icon = '';
      updateIconSelection(noneBtn);
    });
    iconGrid.appendChild(noneBtn);

    // now loop over our SVG strings instead of paths
    iconSvgs.forEach((svgString, idx) => {
      const btn = document.createElement('div');
      btn.className = 'icon-button';
      // inject the raw SVG markup directly
      btn.innerHTML = svgString;
      btn.addEventListener('click', () => {
        currentSelection.icon = svgString;
        updateIconSelection(btn);
      });
      iconGrid.appendChild(btn);
    });
  }

  function updateIconSelection(selectedBtn) {
    iconGrid.querySelectorAll('.icon-button').forEach(b => b.classList.remove('selected'));
    selectedBtn.classList.add('selected');
  }

  function createGrid(size) {
    const [cols, rows] = size.split('x').map(Number);
    const gridInner = document.getElementById('gridInner');
    gridInner.style.display = 'grid';
    gridInner.style.gridTemplateColumns = `repeat(${cols}, minmax(60px, 100px))`;
    gridInner.innerHTML = '';

    let isPainting = false;
    let currentBulk = [];

    function endBulkPaint() {
      if (isPainting && currentBulk.length) {
        undoStack.push([...currentBulk]);
        redoStack.length = 0;
        updateUndoRedoButtons();
      }
      isPainting = false;
    }

    gridInner.addEventListener('mouseup', endBulkPaint);
    gridInner.addEventListener('touchend', () => {
      if (isPainting && currentBulk.length > 0) {
        undoStack.push([...currentBulk]);
        redoStack.length = 0;
        updateUndoRedoButtons();
      }
      isPainting = false;
    }, { passive: true });
    for (let i = 0; i < cols * rows; i++) {
      const square = document.createElement('div');
      square.className = 'square';
      square.addEventListener('mousedown', () => {
        isPainting = true;
        currentBulk = [];
        currentBulk.push(snapshotSquare(square));
        customizeSquare(square, false);
      });
      square.addEventListener('mouseenter', () => {
        if (isPainting) {
          if (!currentBulk.find(s => s.square === square)) {
            currentBulk.push(snapshotSquare(square));
          }
          customizeSquare(square, false);
        }
      });
      square.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isPainting = true;
        currentBulk = [];
        currentBulk.push(snapshotSquare(square));
        customizeSquare(square, false);
      }, { passive: false });
      gridInner.addEventListener('touchmove', (e) => {
        if (!isPainting) return;
        const touch = e.touches[0];
        const elem = document.elementFromPoint(touch.clientX, touch.clientY);
        if (elem?.classList.contains('square') && !currentBulk.some(s => s.square === elem)) {
          currentBulk.push(snapshotSquare(elem));
          customizeSquare(elem, false);
        }
      }, { passive: false });
      gridInner.appendChild(square);
    }
  }

  function snapshotSquare(square) {
    return {
      square,
      bg: square.style.backgroundColor,
      border: square.style.borderColor,
      icon: square.querySelector('img')?.src || ''
    };
  }
  function customizeSquare(square, record = true) {
    clearBtn.disabled = false;
    if (record) {
      undoStack.push([snapshotSquare(square)]);
      redoStack.length = 0;
      updateUndoRedoButtons();
    }
    if (editMode === 'all' || editMode === 'color') {
      square.style.backgroundColor = currentSelection.bg;
      square.style.borderColor = currentSelection.border;
    }
    if (editMode === 'all' || editMode === 'pattern') {
      // wipe out any previous icon
      square.innerHTML = '';
      if (currentSelection.icon) {
        // directly insert the SVG markup
        square.innerHTML = currentSelection.icon;
      }
    }
  }

  document.addEventListener('mouseup', () => {
    const gridInner = document.getElementById('gridInner');
    const event = new Event('mouseup');
    gridInner.dispatchEvent(event);
  });

  document.addEventListener('touchend', () => {
    const gridInner = document.getElementById('gridInner');
    const event = new Event('touchend');
    gridInner.dispatchEvent(event);
  });

  function clearSquareContent(square) {
    while (square.firstChild) {
      square.removeChild(square.firstChild);
    }
  }

  function updateUndoRedoButtons() {
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = redoStack.length === 0;
  }

  layoutSelect.addEventListener('change', () => {
    undoStack.length = 0;
    redoStack.length = 0;
    clearBtn.disabled = true;
    updateUndoRedoButtons();
    createGrid(layoutSelect.value);
  });

  bgColorInput.addEventListener('input', () => {
    currentSelection.bg = bgColorInput.value;
    let matched = false;
    bgPalette.querySelectorAll('.color-button').forEach(b => {
      if (b.style.backgroundColor === bgColorInput.value) {
        b.classList.add('selected');
        matched = true;
      } else {
        b.classList.remove('selected');
      }
    });
    bgColorInput.classList.toggle('selected', !matched);
  });

  borderColorInput.addEventListener('input', () => {
    currentSelection.border = borderColorInput.value;
    let matched = false;
    borderPalette.querySelectorAll('.color-button').forEach(b => {
      if (b.style.backgroundColor === borderColorInput.value) {
        b.classList.add('selected');
        matched = true;
      } else {
        b.classList.remove('selected');
      }
    });
    borderColorInput.classList.toggle('selected', !matched);
  });

  function init() {
    createPalette(bgPalette, presetBGColors, 'bg');
    createPalette(borderPalette, presetBorderColors, 'border');
    createIconGrid();
    createGrid(layoutSelect.value);
    updateUndoRedoButtons(); 
    updateLayoutLabels();
  }

  applyAllBtn.addEventListener('click', () => {
    const squares = document.querySelectorAll('.square');
    const snapshot = Array.from(squares).map(square => (snapshotSquare(square)));
    undoStack.push(snapshot);
    redoStack.length = 0;
    document.querySelectorAll('.square').forEach(square => customizeSquare(square, false));
    updateUndoRedoButtons();
  });

  clearBtn.addEventListener('click', () => {
    const squares = document.querySelectorAll('.square');
    const snapshot = Array.from(squares).map(snapshotSquare);
    undoStack.push(snapshot);
    redoStack.length = 0;
    squares.forEach(square => {
      square.style.backgroundColor = '#eee';
      square.style.borderColor = 'transparent';
      clearSquareContent(square);
    });
    clearBtn.disabled = true;
    updateUndoRedoButtons();
  });
  undoBtn.addEventListener('click', () => {
    const lastAction = undoStack.pop();
    if (!lastAction) return;
    const actions = Array.isArray(lastAction) ? lastAction : [lastAction];
    const redoSnapshot = actions.map(({ square }) => snapshotSquare(square));
    redoStack.push(redoSnapshot);
    actions.forEach(({ square, bg, border, icon }) => {
      square.style.backgroundColor = bg;
      square.style.borderColor = border;
      clearSquareContent(square);
      if (icon) {
        const img = document.createElement('img');
        img.src = icon;
        img.alt = '';
        square.appendChild(img);
      }
    });
    updateUndoRedoButtons();
  });

  redoBtn.addEventListener('click', () => {
    const nextAction = redoStack.pop();
    if (!nextAction) return;
    const undoSnapshot = nextAction.map(({ square }) => snapshotSquare(square));
    undoStack.push(undoSnapshot);
    nextAction.forEach(({ square, bg, border, icon }) => {
      square.style.backgroundColor = bg;
      square.style.borderColor = border;
      clearSquareContent(square);
      if (icon) {
        const img = document.createElement('img');
        img.src = icon;
        img.alt = '';
        square.appendChild(img);
      }
    });
    updateUndoRedoButtons();
  });

  exportBtn.addEventListener('click', () => {
    const gridInner = document.getElementById('gridInner');
    const clone = gridInner.cloneNode(true);

    const wrapper = document.createElement('div');
    wrapper.style.position = 'absolute';
    wrapper.style.top = '-9999px';
    wrapper.style.left = '-9999px';
    wrapper.style.background = 'white';
    wrapper.style.padding = '20px';
    wrapper.style.display = 'inline-block';
    wrapper.appendChild(clone);

    document.body.appendChild(wrapper);

      html2canvas(wrapper).then(canvas => {
      document.body.removeChild(wrapper);
      const link = document.createElement('a');
      link.download = 'crochet_layout.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  });

  randomizeBtn.addEventListener('click', () => {
    const squares = document.querySelectorAll('.square');
    const snapshot = Array.from(squares).map(square => (snapshotSquare(square)));
    undoStack.push(snapshot);
    redoStack.length = 0;

    squares.forEach(square => {
      if (editMode === 'all' || editMode === 'color') {
        const randomBG = presetBGColors[Math.floor(Math.random() * presetBGColors.length)];
        const randomBorder = presetBorderColors[Math.floor(Math.random() * presetBorderColors.length)];
        square.style.backgroundColor = randomBG;
        square.style.borderColor = randomBorder;
      }

      if (editMode === 'all' || editMode === 'pattern') {
        square.innerHTML = '';
        const randomIcon = Math.random() < 0.5 ? '' : iconPaths[Math.floor(Math.random() * iconPaths.length)];
        if (randomIcon) {
          const img = document.createElement('img');
          img.src = randomIcon;
          img.alt = '';
          square.appendChild(img);
        }
      }
    });
    clearBtn.disabled = false;
    updateUndoRedoButtons();
  });

  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
      e.preventDefault();
      undoBtn.click();
    }
    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))) {
      e.preventDefault();
      redoBtn.click();
    }
  });

  function setMobileControls(isOpen) {
    controls.style.display = isOpen ? 'block' : 'none';
    closeBtn.style.display = isOpen ? 'flex' : 'none';
    header.style.display = isOpen ? 'none' : 'flex';
  }
  function updateLayoutLabels() {
    const isMobile = window.innerWidth < 800;
    Array.from(layoutSelect.options).forEach(option => {
      const fullLabel = option.value.replace('x', ' x ') + ' squares';
      const shortLabel = option.getAttribute('data-short');
      option.textContent = isMobile ? shortLabel : fullLabel;
    });
  }
  toggleBtn.addEventListener('click', () => {
    setMobileControls(true);
  });
  closeBtn.addEventListener('click', () => {
    hint.style.display = 'none';
    setMobileControls(false);
  });
  window.addEventListener('resize', () => {
    if (window.innerWidth > 800) {
      controls.style.display = 'flex';
      closeBtn.style.display = 'none';
      header.style.display = 'flex';
      updateLayoutLabels();
    } else {
      // If previously opened in desktop and shrinks to mobile, keep controls hidden until toggle
      controls.style.display = 'none';
      closeBtn.style.display = 'flex';   
      header.style.display = 'flex';   
      updateLayoutLabels();
    }
  });

  init();
})();
</script>

</body>
</html>
